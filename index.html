<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>AXTROM</title>
  <link rel="icon" type="image/png" href="favicon.png?v=3">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <style>
    /* =========================================================
       ESTILOS ORIGINALES AXTROM v0.3 (INTACTOS)
       ========================================================= */
    * {
      box-sizing: border-box;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }
    .header-proauto {
      position: sticky; top: 0; background: #ffffff; z-index: 1000; border-bottom: 1px solid #e6e8ec;
    }
    #auditoriaBody tr:nth-child(even) { background: #f7f7f7; }
    #auditoriaBody tr:nth-child(odd) { background: #ffffff; }
    #auditoriaBody tr:hover { background: #e6f2ff; }
    #auditoriaBody td, #tablaAuditoria th { padding: 10px 14px; font-size: 13px; border-bottom: 1px solid #ddd; }
    #tablaAuditoria { width: 100%; border-collapse: collapse; font-family: system-ui, sans-serif; margin-top: 10px; background: white; border-radius: 8px; overflow: hidden; }
    #tablaAuditoria thead { background: #e0e0e0; color: #333; position: sticky; top: 0; z-index: 2; }
    #tablaAuditoria th { font-weight: 600; text-align: left; }
    .auditoria-container { max-height: 450px; overflow-y: auto; border-radius: 8px; border: 1px solid #ddd; background: #fff; margin-top: 15px; }
    #vehicleSummary { position: fixed; top: 110px; right: 16px; width: 420px; max-width: calc(100% - 32px); background: #f1f4f9; border: 1px solid #d6dbea; border-radius: 12px; padding: 16px 18px; box-shadow: 0 8px 24px rgba(0,0,0,0.15); z-index: 2000; display: none; }
    #vehicleSummary.show { display: block; }
    body { margin: 0; padding: 16px; background: #f5f5f7; }
    .header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px; }
    .header-left { display: flex; align-items: center; gap: 12px; }
    .logo { height: 42px; }
    .logo-header { height: 64px; margin-right: 14px; mix-blend-mode: multiply; }
    h1 { margin: 0; font-size: 20px; }
    .subtitle { margin: 0; color: #555; font-size: 13px; }
    .top-actions { display: flex; justify-content: flex-end; margin-bottom: 10px; gap: 8px; }
    .vehicle-summary { margin-top: 12px; margin-bottom: 16px; padding: 10px 16px; background: #f5f7fb; border-radius: 12px; border: 1px solid #dde3f0; display: flex; justify-content: space-between; align-items: flex-start; font-size: 13px; color: #222; box-shadow: 0 1px 3px rgba(0,0,0,0.06); }
    .vehicle-summary.hidden { display: none; }
    .vs-main { display: flex; flex-direction: column; gap: 4px; }
    .vs-row { display: flex; flex-wrap: wrap; gap: 6px; align-items: center; }
    .vs-label { font-weight: 600; color: #555; }
    .vs-value { font-weight: 500; }
    .vs-ot { font-style: italic; color: #333; }
    .vs-separator { color: #aaa; }
    .vs-close { position: absolute; top: 6px; right: 10px; border: none; background: transparent; font-size: 20px; cursor: pointer; color: #666; }
    .vs-close:hover { color: #444; }
    .btn { border-radius: 999px; padding: 6px 12px; font-size: 12px; border: none; cursor: pointer; }
    .btn-primary { background: #007dc5; color: white; }
    .btn-secondary { background: #e0e0e0; color: #333; }
    .btn-danger { background: #e53935; color: #fff; }
    .btn-link { background: transparent; color: #007dc5; text-decoration: underline; padding: 0; border-radius: 0; }
    .view { display: none; }
    .view.active { display: block; }
    .board { display: flex; gap: 12px; align-items: flex-start; padding-bottom: 20px; overflow-x: auto; min-height: 320px; }
    .column { background: #ffffff; border-radius: 10px; padding: 8px; min-width: 200px; max-width: 240px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
    .column-header { display: flex; justify-content: space-between; align-items: baseline; margin-bottom: 8px; }
    .column-title { font-size: 13px; font-weight: 600; }
    .column-count { font-size: 11px; color: #777; }
    .dropzone { min-height: 40px; padding: 4px; border-radius: 8px; background: #fafafa; }
    .card { background: #fff; border-radius: 8px; padding: 6px 8px; margin-bottom: 6px; box-shadow: 0 1px 3px rgba(0,0,0,0.12); cursor: grab; border-left: 4px solid #007dc5; }
    .card.dragging { opacity: 0.6; }
    .card-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px; }
    .plate { font-weight: 700; font-size: 13px; }
    .brand { font-size: 11px; color: #666; text-align: right; }
    .chip { display: inline-block; font-size: 10px; padding: 2px 6px; border-radius: 999px; background: #eee; margin-right: 4px; }
    .chip.insurer { background: #e3f2fd; color: #035388; }
    .chip-client { font-size: 10px; color: #555; }
    .chip-small { font-size: 9px; background: #f3e5f5; color: #5e35b1; }
    .card-extra { margin-top: 4px; font-size: 10px; color: #555; display: flex; flex-wrap: wrap; gap: 4px; }
    .card-ot { margin-top: 6px; font-size: 11px; background: #f5f5f5; padding: 4px 6px; border-radius: 6px; color: #444; }
    .card-extra-item { background: #f5f5f5; border-radius: 999px; padding: 2px 6px; }
    .dropzone.over { outline: 2px dashed #007dc5; background: #e3f2fd; }
    .panel-form { background: #ffffff; border-radius: 10px; padding: 14px; box-shadow: 0 1px 3px rgba(0,0,0,0.12); }
    .panel-form h2 { margin: 0 0 8px; font-size: 16px; }
    .panel-form p { margin: 0 0 10px; font-size: 12px; color: #666; }
    .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
    .form-section-title { grid-column: 1 / -1; margin-top: 8px; font-size: 12px; font-weight: 600; color: #333; }
    .form-field { display: flex; flex-direction: column; gap: 2px; }
    .form-field label { font-size: 11px; color: #444; }
    .form-field input, .form-field select, .form-field textarea { font-size: 12px; padding: 4px 6px; border-radius: 6px; border: 1px solid #ccc; outline: none; }
    .form-field input:focus, .form-field select:focus, .form-field textarea:focus { border-color: #007dc5; }
    .checklist-group { display: grid; grid-template-columns: 1fr 1fr; gap: 4px 12px; font-size: 11px; }
    .checklist-item { display: flex; align-items: center; gap: 4px; }
    .checklist-item input { margin: 0; }
    .form-actions { margin-top: 12px; display: flex; justify-content: space-between; gap: 8px; align-items: center; flex-wrap: wrap; }
    .form-actions-right { margin-left: auto; display: flex; gap: 8px; }
    .panel-detalle { background: #ffffff; border-radius: 10px; padding: 14px; box-shadow: 0 1px 3px rgba(0,0,0,0.12); }
    .panel-detalle h2 { margin: 0 0 4px; font-size: 16px; }
    .panel-detalle small { color: #666; font-size: 11px; }
    .detalle-header-actions { display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px; gap: 8px; flex-wrap: wrap; }
    .detalle-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 6px 16px; margin-top: 10px; margin-bottom: 10px; font-size: 12px; }
    .detalle-label { font-weight: 600; color: #333; }
    .detalle-value { color: #555; }
    .detalle-subsection-title { margin-top: 8px; font-size: 12px; font-weight: 600; color: #333; }
    .detalle-list { font-size: 11px; color: #555; margin: 4px 0 0; padding-left: 16px; }
    .detalle-archivo a { font-size: 12px; }
    .ordenes-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px; margin-top: 10px; }
    .ordenes-list { border: 1px solid #eee; border-radius: 8px; padding: 8px; max-height: 220px; overflow-y: auto; background: #fafafa; margin-bottom: 10px; }
    .orden-item { padding: 6px 8px; border-radius: 6px; background: #fff; box-shadow: 0 1px 2px rgba(0,0,0,0.06); margin-bottom: 6px; font-size: 12px; }
    .orden-item strong { display: block; font-size: 11px; color: #333; }
    .presupuesto-resumen { list-style: none; padding-left: 0; margin: 4px 0 6px; font-size: 11px; color: #444; }
    .presupuesto-table { border: 1px solid #eee; border-radius: 8px; overflow: hidden; background: #fafafa; margin-bottom: 8px; }
    .presupuesto-header-row, .presupuesto-row { display: grid; grid-template-columns: 0.8fr 1fr 1.3fr 0.4fr 0.7fr; gap: 4px; padding: 4px 8px; font-size: 11px; align-items: center; }
    .presupuesto-header-row { background: #f0f0f0; font-weight: 600; border-bottom: 1px solid #e0e0e0; }
    .presupuesto-row:nth-child(odd) { background: #ffffff; }
    .presupuesto-row:nth-child(even) { background: #f9f9f9; }
    .presupuesto-importes { text-align: right; }
    .orden-actions { margin-top: 4px; display: flex; gap: 6px; }
    .orden-btn { border: none; border-radius: 999px; padding: 2px 8px; font-size: 10px; cursor: pointer; }
    .orden-btn-edit { background: #e3f2fd; }
    .orden-btn-delete { background: #ffebee; }
    .presupuesto-actions { margin-top: 2px; display: flex; gap: 4px; justify-content: flex-end; }
    .presupuesto-btn { border: none; border-radius: 999px; padding: 1px 6px; font-size: 10px; cursor: pointer; }
    .presupuesto-btn-edit { background: #e3f2fd; }
    .presupuesto-btn-delete { background: #ffebee; }
    .presupuesto-form-inline { display: grid; grid-template-columns: 0.8fr 1fr 1.2fr 0.4fr 0.7fr 1.2fr; gap: 4px; margin-bottom: 4px; font-size: 11px; }
    .vehicle-summary { background: #eef2f7; border: 1px solid #d0d7e3; padding: 12px 18px; border-radius: 10px; margin-top: 15px; margin-bottom: 20px; }
    .vehicle-summary.hidden { display: none; }
    .vs-row { margin-bottom: 6px; }
    .vs-close { background: transparent; border: none; float: right; font-size: 22px; cursor: pointer; }
    .presupuesto-form-inline input, .presupuesto-form-inline select { font-size: 11px; padding: 3px 4px; border-radius: 6px; border: 1px solid #ccc; }
    .presupuesto-form-actions { display: flex; justify-content: flex-end; }
    @media (max-width: 900px) {
      .detalle-grid, .form-grid, .checklist-group { grid-template-columns: 1fr; }
      .presupuesto-header-row, .presupuesto-row, .presupuesto-form-inline { grid-template-columns: 1fr; }
    }
    .vs-section { margin-bottom: 14px; padding-bottom: 10px; border-bottom: 1px solid #e4e7ec; }
    .vs-section:last-child { border-bottom: none; }
    .vs-title { font-size: 11px; font-weight: 600; color: #6b7280; text-transform: uppercase; margin-bottom: 6px; }
    /* =========================================
       ESTILOS NOTIFICACIONES (PROFESIONAL)
       ========================================= */
    .btn-notif { 
        position: relative; 
        background: #fff; 
        border: 1px solid #e2e8f0; 
        color: #64748b; 
        font-size: 16px; 
        padding: 8px 12px; 
        border-radius: 50%; 
        cursor: pointer;
        transition: all 0.2s;
    }
    .btn-notif:hover { background: #f1f5f9; color: #007dc5; }
    
    .notif-badge { 
        position: absolute; top: -2px; right: -2px; 
        background: #ef4444; color: white; 
        border-radius: 50%; font-size: 10px; 
        width: 18px; height: 18px; 
        display: flex; align-items: center; justify-content: center; 
        font-weight: 700; border: 2px solid #fff;
    }

    /* MEN√ö FLOTANTE MEJORADO */
    .notif-panel {
        position: absolute; 
        top: 50px; /* Separaci√≥n del bot√≥n */
        left: 0;
        width: 320px; /* Ancho fijo elegante */
        max-height: 400px; 
        overflow-y: auto; 
        background: white; 
        border: none; 
        border-radius: 12px; 
        box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.1); /* Sombra suave */
        z-index: 9999; /* Para que flote SOBRE todo */
        display: none; /* Oculto por defecto */
        flex-direction: column;
    }
    
    /* Flechita decorativa arriba del men√∫ */
    .notif-panel::before {
        content: ""; position: absolute; top: -6px; left: 14px;
        width: 12px; height: 12px; background: white;
        transform: rotate(45deg); border-top: 1px solid #f1f5f9; border-left: 1px solid #f1f5f9;
    }

    .notif-panel.show { display: flex; animation: slideDown 0.2s ease-out; }

    .notif-header { 
        padding: 12px 16px; 
        border-bottom: 1px solid #f1f5f9; 
        display: flex; justify-content: space-between; align-items: center;
        background: #fff; border-radius: 12px 12px 0 0;
    }
    
    .notif-item { 
        padding: 12px 16px; 
        border-bottom: 1px solid #f8fafc; 
        display: flex; flex-direction: column; gap: 4px; 
        cursor: default;
        transition: background 0.2s;
    }
    .notif-item:last-child { border-bottom: none; }
    .notif-item:hover { background: #f8fafc; }
    
    /* Estado NO LE√çDO (Azul muy suave y borde izquierdo) */
    .notif-item.unread { 
        background: #f0f9ff; 
        border-left: 3px solid #007dc5; 
    }
    
    .notif-msg { font-size: 12px; color: #334155; line-height: 1.4; }
    .notif-time { font-size: 10px; color: #94a3b8; align-self: flex-end; font-weight: 500;}

    @keyframes slideDown {
        from { opacity: 0; transform: translateY(-10px); }
        to { opacity: 1; transform: translateY(0); }
    }
    /* =========================================================
       NUEVOS ESTILOS: INTEGRACI√ìN LAVADORA
       ========================================================= */
    /* Subzonas verticales en el tablero principal */
    .lavado-subzone-container { display: flex; flex-direction: column; gap: 6px; min-height: 100%; }
    .lavado-subzone { background: #f1f5f9; border: 1px dashed #cbd5e1; border-radius: 8px; padding: 6px; min-height: 50px; }
    .lavado-subzone-title { font-size: 9px; font-weight: 800; color: #64748b; text-transform: uppercase; margin-bottom: 4px; }
    
    /* Vista Exclusiva Lavador */
    #view-lavador { max-width: 1200px; margin: 0 auto; }
    .lavador-header { background: #007dc5; color: white; padding: 20px; border-radius: 12px; margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center; }
    .lavador-board { display: flex; gap: 15px; overflow-x: auto; padding-bottom: 20px; }
    .lavador-column { flex: 1; background: white; border-radius: 10px; padding: 10px; min-width: 250px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); border-top: 4px solid #007dc5; }
    .lavador-card { background: #f8fafc; border: 1px solid #e2e8f0; padding: 12px; border-radius: 8px; margin-bottom: 10px; border-left: 4px solid #4caf50; }
    .lavador-card-plate { font-size: 18px; font-weight: 800; color: #333; }
    .lavador-controls { margin-top: 10px; display: flex; gap: 5px; }
    /* =========================================
   ESTILOS VENTANA EMERGENTE (PRESUPUESTO)
   ========================================= */
.modal-overlay {
  position: fixed; top: 0; left: 0; width: 100%; height: 100%;
  background: rgba(0, 0, 0, 0.5); z-index: 10000;
  display: none; justify-content: center; align-items: center;
  backdrop-filter: blur(4px);
}

.modal-content {
  background: white; width: 500px; max-width: 95%;
  border-radius: 8px; overflow: hidden;
  box-shadow: 0 10px 25px rgba(0,0,0,0.2);
  font-family: system-ui, sans-serif;
  animation: slideUp 0.3s ease-out;
}

@keyframes slideUp { from {transform: translateY(20px); opacity: 0;} to {transform: translateY(0); opacity: 1;} }

.pres-header {
  background: #007dc5; /* üîµ CAMBIO: Azul corporativo */
  color: white; padding: 10px 15px;
  display: flex; justify-content: space-between; align-items: center;
  font-weight: bold; font-size: 14px;
}

.pres-table { width: 100%; border-collapse: collapse; font-size: 12px; }
.pres-table th { text-align: left; padding: 8px; color: #666; font-weight: normal; border-bottom: 1px solid #eee; }
.pres-table td { padding: 6px 8px; border-bottom: 1px solid #f0f0f0; }
.pres-row-bg { background: #f9f9f9; font-weight: 600; color: #444; }

.pres-input {
  width: 100%; padding: 4px; border: 1px solid #ddd;
  border-radius: 4px; text-align: right; font-family: monospace;
}
.pres-input:focus { border-color: #c62828; outline: none; }

.pres-footer {
  padding: 15px; background: #f5f5f5; display: flex; justify-content: flex-end; gap: 10px;
}
/* CLASES PARA OCULTAR/MOSTRAR SECCIONES */
.pres-section-container {
    border: 1px solid #eee;
    border-radius: 8px;
    margin-bottom: 10px;
    overflow: hidden;
}

.pres-toggle-header {
    background: #f8f9fa;
    padding: 10px 15px;
    display: flex;
    align-items: center;
    gap: 10px;
    cursor: pointer;
    border-bottom: 1px solid transparent;
    transition: all 0.2s;
}

.pres-toggle-header:hover {
    background: #eef2f7;
}

.pres-toggle-header.active {
    background: #e3f2fd;
    border-bottom: 1px solid #dee2e6;
    color: #007dc5;
    font-weight: bold;
}

.pres-content-body {
    display: none; /* Oculto por defecto */
    padding: 10px;
    animation: fadeIn 0.3s;
}

.pres-content-body.show {
    display: block; /* Mostrar cuando tenga la clase */
}

@keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

/* Checkbox personalizado m√°s grande */
.big-check {
    width: 18px;
    height: 18px;
    cursor: pointer;
}
/* =========================================
   ESTILOS NUEVA VISTA DETALLE (REDDISE√ëO)
   ========================================= */
.detail-header-card {
    background: linear-gradient(135deg, #007dc5 0%, #005a8d 100%);
    color: white; padding: 20px; border-radius: 12px;
    display: flex; justify-content: space-between; align-items: center;
    margin-bottom: 20px; box-shadow: 0 4px 12px rgba(0,125,197,0.2);
}
.detail-main-grid {
    display: grid; grid-template-columns: 2fr 1fr; gap: 20px;
}
.detail-card {
    background: white; border-radius: 12px; padding: 20px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.05); border: 1px solid #eef2f6;
    margin-bottom: 20px;
}
.detail-card h3 {
    margin-top: 0; margin-bottom: 15px; font-size: 14px; 
    color: #007dc5; text-transform: uppercase; border-bottom: 2px solid #f0f4f8; 
    padding-bottom: 8px;
}
.info-row {
    display: flex; justify-content: space-between; border-bottom: 1px solid #f8fafc;
    padding: 8px 0; font-size: 13px;
}
.info-row:last-child { border-bottom: none; }
.info-label { color: #64748b; font-weight: 500; }
.info-val { color: #1e293b; font-weight: 600; text-align: right; }

/* Tabla Financiera en Detalle */
.fin-table { width: 100%; border-collapse: collapse; font-size: 12px; }
.fin-table th { background: #f8fafc; color: #475569; padding: 8px; text-align: right; border-bottom: 2px solid #e2e8f0; }
.fin-table th:first-child { text-align: left; }
.fin-table td { padding: 8px; text-align: right; border-bottom: 1px solid #f1f5f9; color: #334155; }
.fin-table td:first-child { text-align: left; font-weight: 600; }
.fin-total-row { background: #f0f9ff; font-weight: 800; color: #007dc5; }

/* Galer√≠a de Fotos */
.gallery-grid {
    display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 10px;
}
.gallery-item {
    position: relative; height: 100px; border-radius: 8px; overflow: hidden;
    border: 1px solid #ddd; cursor: pointer; transition: transform 0.2s;
}
.gallery-item:hover { transform: scale(1.05); box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
.gallery-img { width: 100%; height: 100%; object-fit: cover; }
.gallery-overlay {
    position: absolute; bottom: 0; left: 0; right: 0; 
    background: rgba(0,0,0,0.6); color: white; 
    font-size: 10px; padding: 4px; text-align: center; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
}
/* Estilo para lista de documentos (PDFs) */
.doc-list { display: flex; flex-direction: column; gap: 8px; }
.doc-item { 
    display: flex; align-items: center; gap: 10px; 
    background: #f8fafc; padding: 10px; border-radius: 8px; 
    border: 1px solid #e2e8f0; transition: background 0.2s;
}
.doc-item:hover { background: #f1f5f9; }
.doc-icon { font-size: 20px; color: #ef4444; /* Rojo tipo PDF */ }
.doc-link { text-decoration: none; color: #334155; font-weight: 500; font-size: 12px; flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
.doc-download { color: #007dc5; font-size: 14px; cursor: pointer; }
  </style>
</head>
<body>

<div id="loginScreen">
  <style>
    /* Contenedor Principal */
    #loginScreen {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: linear-gradient(135deg, #0a1120 0%, #002b4d 100%);
      display: flex; align-items: center; justify-content: center;
      z-index: 99999; font-family: 'Segoe UI', system-ui, sans-serif;
      overflow: hidden;
    }
    
    /* Patr√≥n de puntitos sutil */
    #loginScreen::before {
      content: ""; position: absolute; top: 0; left: 0; width: 100%; height: 100%;
      background-image: radial-gradient(#ffffff 1px, transparent 1px);
      background-size: 30px 30px; opacity: 0.03; pointer-events: none;
    }

    /* SOMBRA GIGANTE DEL √çCONO A LA DERECHA */
    #loginScreen::after {
      content: ""; position: absolute; top: 50%; right: -5%; width: 70vh; height: 70vh;
      background-image: url('favicon.png'); background-repeat: no-repeat;
      background-position: center; background-size: contain;
      transform: translateY(-50%) rotate(-15deg);
      opacity: 0.05; filter: grayscale(100%) contrast(200%);
      pointer-events: none; z-index: -1;
    }

    .login-card {
      background: rgba(255, 255, 255, 0.97);
      backdrop-filter: blur(15px);
      width: 400px; padding: 45px;
      border-radius: 24px;
      box-shadow: 0 30px 60px rgba(0,0,0,0.4), inset 0 0 0 1px rgba(255,255,255,0.5);
      text-align: center; position: relative;
      animation: slideUp 0.7s cubic-bezier(0.2, 0.8, 0.2, 1);
    }

    @keyframes slideUp { from { transform: translateY(50px) scale(0.95); opacity: 0; } to { transform: translateY(0) scale(1); opacity: 1; } }

    /* ‚úÖ CAMBIO AQU√ç: LOGO M√ÅS GRANDE */
    .login-logo { 
      height: 150px; /* Antes era 75px */
      margin-bottom: 25px; object-fit: contain;
      filter: drop-shadow(0 5px 8px rgba(0,0,0,0.25)); /* Sombra un poco m√°s fuerte */
    }
    
    .login-title { margin: 0; color: #0f172a; font-size: 26px; font-weight: 900; letter-spacing: -0.5px; }
    .login-subtitle { margin: 8px 0 35px; color: #64748b; font-size: 14px; font-weight: 500; }

    .input-group-login { position: relative; margin-bottom: 18px; text-align: left; }
    
    .input-group-login i {
      position: absolute; left: 16px; top: 50%; transform: translateY(-50%);
      color: #94a3b8; font-size: 15px; transition: color 0.3s;
    }

    .input-login {
      width: 100%; padding: 14px 14px 14px 45px;
      border: 2px solid #e2e8f0; border-radius: 12px;
      font-size: 15px; outline: none; transition: all 0.3s;
      background: #f1f5f9; color: #334155; font-weight: 500;
    }

    .input-login:focus { border-color: #007dc5; background: white; box-shadow: 0 0 0 4px rgba(0, 125, 197, 0.15); }
    .input-login:focus + i { color: #007dc5; }

    .btn-login-main {
      width: 100%; padding: 16px; margin-top: 15px;
      background: linear-gradient(90deg, #007dc5 0%, #004e7a 100%);
      color: white; border: none; border-radius: 12px;
      font-size: 16px; font-weight: 800; cursor: pointer; letter-spacing: 0.5px;
      transition: transform 0.2s, box-shadow 0.2s, filter 0.2s;
      box-shadow: 0 10px 25px -5px rgba(0, 125, 197, 0.5);
    }

    .btn-login-main:hover { transform: translateY(-3px); box-shadow: 0 15px 35px -5px rgba(0, 125, 197, 0.6); filter: brightness(110%); }
    .btn-login-main:active { transform: translateY(0); }

    .login-footer { margin-top: 30px; font-size: 12px; color: #94a3b8; font-weight: 500; }
  </style>

  <div class="login-card">
    <img src="logo_axiis.png" alt="AXTROM" class="login-logo">
    
    <h2 class="login-title">Bienvenido</h2>
    <p class="login-subtitle">Sistema de Gesti√≥n de Taller</p>

    <div id="view-login" class="view active">
        <div class="input-group-login">
            <input id="loginUsuario" type="text" class="input-login" placeholder="Usuario" autocomplete="off">
            <i class="fa-solid fa-user"></i>
        </div>
        <div class="input-group-login">
            <input id="loginPassword" type="password" class="input-login" placeholder="Contrase√±a">
            <i class="fa-solid fa-lock"></i>
        </div>
        <button id="btnLogin" class="btn-login-main">
            INICIAR SESI√ìN <i class="fa-solid fa-chevron-right" style="margin-left:10px; font-size:14px;"></i>
        </button>
    </div>

    <div class="login-footer">
        ¬© 2026 Powered by AXTROM Tech
    </div>
  </div>
</div>
  </div>
</div>
</div>

<div id="main-container">
  <header class="header header-proauto">
    <div class="header-left">
      <img src="logo_axis.png" alt="AXIS" class="logo logo-header" />
      <div>
       <h1>Tablero de veh√≠culos en taller</h1>
        <p class="subtitle">Gesti√≥n visual de √≥rdenes de trabajo - AXIS</p>
        <button id="vs-close" class="vs-close">&times;</button>
        <div id="vehicle-summary" class="vehicle-summary hidden">
          <div class="vs-section">
            <div class="vs-title">Veh√≠culo</div>
            <div class="vs-row"><strong><i class="fa-solid fa-id-card"></i> Placa:</strong> <span id="vs-placa"></span></div>
            <div class="vs-row"><strong><i class="fa-solid fa-fingerprint"></i> VIN:</strong> <span id="vs-vin"></span></div>
            <div class="vs-row"><strong><i class="fa-solid fa-car-side"></i> Modelo:</strong> <span id="vs-modelo"></span></div>
          </div>
          <div class="vs-section">
            <div class="vs-title">Responsables</div>
            <div class="vs-row"><strong><i class="fa-solid fa-user"></i> Cliente:</strong> <span id="vs-propietario"></span></div>
            <div class="vs-row"><strong><i class="fa-solid fa-shield-halved"></i> Aseguradora:</strong> <span id="vs-aseguradora"></span></div>
            <div class="vs-row"><strong><i class="fa-solid fa-user-tie"></i> Asesor:</strong> <span id="vs-asesor"></span></div>
            <div class="vs-row"><strong><i class="fa-solid fa-user-gear"></i> T√©cnico:</strong> <span id="vs-tecnico"></span></div>
          </div>
          <div class="vs-section">
            <div class="vs-title">Estado</div>
            <div class="vs-row"><strong><i class="fa-solid fa-calendar-plus"></i> Ingreso:</strong> <span id="vs-fecha-ing"></span></div>
            <div class="vs-row"><strong><i class="fa-solid fa-calendar-check"></i> Entrega:</strong> <span id="vs-fecha-sal"></span></div>
            <div class="vs-row"><strong><i class="fa-solid fa-diagram-project"></i> Estado:</strong> <span id="vs-estado"></span></div>
            <div class="vs-row"><strong><i class="fa-solid fa-clipboard-list"></i> √öltima OT:</strong> <span id="vs-ot"></span></div>
          </div>
        </div>
      </div>
    </div>
  </header>

  <div id="nav-buttons" style="padding: 10px;">
    <div style="display:inline-block; position:relative; margin-right:5px;">
        <button id="btnNotificaciones" class="btn btn-notif">
            <i class="fa-solid fa-bell"></i>
            <span id="notifBadge" class="notif-badge" style="display:none;">0</span>
        </button>
        <div id="notifPanel" class="notif-panel">
            <div style="padding:10px; border-bottom:1px solid #eee; display:flex; justify-content:space-between; align-items:center;">
                <strong>Notificaciones</strong>
                <button id="btnMarkRead" style="border:none; background:none; color:#007dc5; cursor:pointer; font-size:11px;">Marcar le√≠das</button>
            </div>
            <div id="notifList"></div>
        </div>
    </div>
    <button id="btnVerTablero" class="btn btn-secondary"><i class="fa-solid fa-table-columns"></i> Ver tablero</button>
    <button id="btnAgregarVehiculo" class="btn btn-primary"><i class="fa-solid fa-car"></i> Agregar / editar veh√≠culo</button>
    <button id="btnLogout" class="btn btn-danger"><i class="fa-solid fa-right-from-bracket"></i> Cerrar sesi√≥n</button>
    <button id="btnAuditoria" class="btn btn-secondary"><i class="fa-solid fa-clipboard-check"></i> Auditor√≠a</button>
    <button id="btnPresupuesto" class="btn btn-secondary"><i class="fa-solid fa-file-invoice-dollar"></i> Presupuesto</button>
    <button id="btnGuardarLocal" class="btn btn-secondary">
    
      <input type="file" id="inputCargarLocal" accept="application/json" style="display:none" />
      <i class="fa-solid fa-floppy-disk"></i> Guardar respaldo
    </button>
    <button id="btnCargarLocal" class="btn btn-secondary">
      <i class="fa-solid fa-folder-open"></i> Cargar respaldo
      <input type="file" id="inputCargarLocalInput" accept="application/json" style="display:none" />
    </button>
    <button id="btnVerFacturados" class="btn btn-primary" style="background:#2e7d32;">
    <i class="fa-solid fa-file-invoice-dollar"></i> Facturados
</button>
  </div>

  <div style="display:flex;justify-content:flex-end;margin-bottom:8px;padding:0 10px;">
    <input id="searchInput" type="text" placeholder="Buscar por placa, modelo, propietario..." style="padding:4px 8px;border-radius:8px;border:1px solid #ccc;font-size:12px;max-width:220px;width:100%;">
  </div>
  <section id="view-tablero" class="view active" style="padding:10px;">
    <div class="board" id="board"></div>
  </section>

  <div id="userInfoBox" style="position: fixed; top: 12px; right: 12px; background: rgba(255, 255, 255, 0.95); padding: 10px 16px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.15); font-family: system-ui; z-index: 9999; display: none; backdrop-filter: blur(6px);">
    <div style="font-weight:600;font-size:15px;" id="userInfoName"></div>
    <div style="font-size:12px;color:#444;" id="userInfoRole"></div>
  </div>

  <section id="view-form" class="view" style="padding:10px;">
    <div class="panel-form">
      <h2 id="form-title">Nuevo veh√≠culo</h2>
      <p id="form-subtitle">Registre los datos del veh√≠culo. Se agregar√° en el estado <strong>Falta de inspecci√≥n</strong>.</p>
      <form id="vehicleForm">
        <div class="form-grid">
          <div class="form-field"><label for="vin">VIN</label><input type="text" id="vin" name="vin" placeholder="Ej: 3N1AB7AP4HY123456" /></div>
          <div class="form-field"><label for="fecha_ingreso">Fecha ingreso</label><input type="date" id="fecha_ingreso" name="fecha_ingreso"></div>
          <div class="form-field"><label for="fecha_salida">Fecha salida</label><input type="date" id="fecha_salida" name="fecha_salida"></div>
          <div class="form-field"><label for="placa">Placa *</label><input type="text" id="placa" name="placa" required placeholder="Ej: ABC1234" /></div>
          <div class="form-field">
            <label for="modelo">Modelo / Veh√≠culo *</label>
            <input type="text" id="modelo" name="modelo" list="modelosChevrolet" required placeholder="Ej: Onix Turbo Sed√°n" />
            <datalist id="modelosChevrolet">
              <option value="Onix Turbo RS"></option><option value="Onix Turbo Sed√°n"></option><option value="Montana"></option><option value="Nuevo Groove"></option><option value="Tracker Turbo"></option><option value="Captiva XL"></option><option value="Nueva Tahoe"></option><option value="Nueva Trailblazer"></option><option value="Suburban"></option><option value="N400 Cargo"></option><option value="N400 Pasajeros"></option><option value="D-Max"></option><option value="Colorado"></option><option value="Silverado"></option>
            </datalist>
          </div>
          <div class="form-field"><label for="propietario">Propietario *</label><input type="text" id="propietario" name="propietario" required placeholder="Nombre del cliente" /></div>
          <div class="form-field"><label for="cedula">C√©dula / ID cliente</label><input type="text" id="cedula" name="cedula" placeholder="Ej: 1102xxxxxx" /></div>
          <div class="form-field">
            <label for="aseguradora">Aseguradora</label>
            <select id="aseguradora" name="aseguradora">
              <option value="">Sin aseguradora</option><option>Retail</option><option>CHUBB Seguros</option><option>Zurich Seguros</option><option>Latina Seguros</option><option>AIG Metropolitana</option><option>VAZ Seguros</option><option>Seguros Alianza</option><option>Mapfre</option><option>Aseguradora del Sur</option><option>Seguros Unidos S.A.</option><option>EQUISUIZA</option><option>Generali Ecuador</option><option>Flotas</option><option>Sweaden Seguros</option>
            </select>
          </div>
          <div class="form-field">
            <label for="asesor">Asesor de servicio</label>
            <select id="asesor" name="asesor" class="form-select">
            <option value="">Seleccione asesor</option><option value="Jhonathan Cevallos">Jhonathan Cevallos</option><option value="Pablo Le√≥n">Pablo Le√≥n</option><option value="Magno Hugo">Magno Hugo</option><option value="Marcos Ibarra">Marcos Ibarra</option>
            </select>
          </div>
          <div class="form-field">
            <label for="tecnico">Tecnico encargado</label>
            <select id="tecnico" name="tecnico">
              <option value="">Seleccione tecnico</option><option>ANGEL ANGUISACA</option><option>CARLOS CAJAMARCA</option><option>DIEGO CAMPOVERDE</option><option>JUAN ERAS</option><option>JORGE SANCHEZ</option><option>TECNICO TOT</option><option>ROMAN SACA</option>
            </select>
          </div>
          <div class="form-section-title">Archivo de orden de trabajo</div>
          <div class="form-field" style="grid-column: 1 / -1;"><label for="archivo_orden">Adjuntar archivo (PDF, imagen, etc.)</label><input type="file" id="archivo_orden" name="archivo_orden" /></div>
          <div class="form-field" style="grid-column: span 2;"><label for="archivos_cliente">Datos del cliente</label><input type="file" id="archivos_cliente" name="archivos_cliente" multiple></div>
          <div class="form-field" style="grid-column: span 2;"><label for="archivos_autorizaciones">Autorizaciones</label><input type="file" id="archivos_autorizaciones" name="archivos_autorizaciones" multiple></div>
          <div class="form-field" style="grid-column: span 2;"><label for="archivos_proformas">Fotos del veh√≠culo (Ingreso) y Proformas</label><input type="file" id="archivos_proformas" name="archivos_proformas" multiple accept="image/*,application/pdf"></div>
          <div class="form-field"><label for="hora_salida">Hora de entrega</label><input type="time" id="hora_salida" name="hora_salida"></div>
          <div class="form-section-title">Partes afectadas (da√±os)</div>
          <div class="form-field" style="grid-column: 1 / -1;">
            <div class="checklist-group">
              <label class="checklist-item"><input type="checkbox" name="danos" value="Frontal" /> Frontal</label>
              <label class="checklist-item"><input type="checkbox" name="danos" value="Posterior" /> Posterior</label>
              <label class="checklist-item"><input type="checkbox" name="danos" value="Lateral derecho" /> Lateral derecho</label>
              <label class="checklist-item"><input type="checkbox" name="danos" value="Lateral izquierdo" /> Lateral izquierdo</label>
              <label class="checklist-item"><input type="checkbox" name="danos" value="Techo" /> Techo</label>
            </div>
          </div>
          <div class="form-section-title">Equipamiento presente</div>
          <div class="form-field" style="grid-column: 1 / -1;">
            <div class="checklist-group">
              <label class="checklist-item"><input type="checkbox" name="equipamiento" value="Llave / llavero" /> Llave / llavero</label>
              <label class="checklist-item"><input type="checkbox" name="equipamiento" value="Espejos" /> Espejos</label>
              <label class="checklist-item"><input type="checkbox" name="equipamiento" value="Radio / car√°tula" /> Radio / car√°tula</label>
              <label class="checklist-item"><input type="checkbox" name="equipamiento" value="Llanta de emergencia" /> Llanta de emergencia</label>
              <label class="checklist-item"><input type="checkbox" name="equipamiento" value="Herramientas" /> Herramientas</label>
            </div>
          </div>
        </div>
        <div class="form-actions">
          <span id="form-mode-indicator" style="font-size:11px;color:#666;"></span>
          <div class="form-actions-right">
            <button type="button" id="btnCancelarForm" class="btn btn-secondary">Cancelar</button>
            <button type="submit" class="btn btn-primary">Guardar veh√≠culo</button>
          </div>
        </div>
      </form>
    </div>
  </section>

  <section id="view-auditoria" class="view" style="padding:10px;">
    <div class="panel-detalle">
      <button id="btnVolverDesdeAuditoria" class="btn btn-link">&larr; Volver al tablero</button>
      <h2>Auditor√≠a de movimientos</h2>
      <p style="font-size:12px;color:#666;">Se registran todos los movimientos de tarjetas realizados en el tablero.</p>
      <input id="auditoriaSearch" type="text" placeholder="Filtrar por placa..." style="margin: 10px 0; padding: 6px 10px; width: 220px; border-radius: 8px; border: 1px solid #ccc; font-size: 12px;">
      <div class="auditoria-container">
        <table id="tablaAuditoria">
            <thead><tr><th>Fecha</th><th>Hora</th><th>Usuario</th><th>Placa</th><th>Desde</th><th>Hacia</th><th>Acci√≥n</th><th>Descripci√≥n</th></tr></thead>
            <tbody id="auditoriaBody"></tbody>
        </table>
      </div>
    </div>
  </section>
  <section id="view-presupuesto" class="view" style="padding:10px;">
  <div class="panel-detalle">
    <button id="btnVolverDesdePresupuesto" class="btn btn-link">&larr; Volver al tablero</button>
    
    <div style="display:flex; flex-wrap:wrap; justify-content:space-between; align-items:flex-start; margin-bottom:20px; gap:15px;">
        
        <div>
            <h2 style="margin:0; color:#007dc5;">Reporte Financiero</h2>
            <p style="font-size:12px; color:#666; margin:0 0 10px 0;">Filtrar ingresos por fecha de autorizaci√≥n.</p>
            
            <div style="display:flex; gap:10px; align-items:flex-end; background:#f8f9fa; padding:10px; border-radius:8px; border:1px solid #eee;">
                
                <div style="display:flex; flex-direction:column;">
                    <label style="font-size:10px; font-weight:bold; color:#555; margin-bottom:4px;">A√±o</label>
                    <select id="filtroAnio" class="input-filtro" style="padding:5px; border-radius:4px; border:1px solid #ccc; font-size:12px;">
                        <option value="">Todos</option>
                        <option value="2024">2024</option>
                        <option value="2025">2025</option>
                        <option value="2026">2026</option>
                        <option value="2027">2027</option>
                        <option value="2028">2028</option>
                        <option value="2029">2029</option>
                        <option value="2030">2030</option>
                    </select>
                </div>

                <div style="display:flex; flex-direction:column;">
                    <label style="font-size:10px; font-weight:bold; color:#555; margin-bottom:4px;">Mes</label>
                    <select id="filtroMes" class="input-filtro" style="padding:5px; border-radius:4px; border:1px solid #ccc; font-size:12px;">
                        <option value="">Todos</option>
                        <option value="01">Enero</option>
                        <option value="02">Febrero</option>
                        <option value="03">Marzo</option>
                        <option value="04">Abril</option>
                        <option value="05">Mayo</option>
                        <option value="06">Junio</option>
                        <option value="07">Julio</option>
                        <option value="08">Agosto</option>
                        <option value="09">Septiembre</option>
                        <option value="10">Octubre</option>
                        <option value="11">Noviembre</option>
                        <option value="12">Diciembre</option>
                    </select>
                </div>

                <div style="display:flex; flex-direction:column;">
                    <label style="font-size:10px; font-weight:bold; color:#555; margin-bottom:4px;">D√≠a</label>
                    <select id="filtroDia" class="input-filtro" style="padding:5px; border-radius:4px; border:1px solid #ccc; font-size:12px;">
                        <option value="">Todos</option>
                        <option value="01">1</option><option value="02">2</option><option value="03">3</option><option value="04">4</option><option value="05">5</option>
                        <option value="06">6</option><option value="07">7</option><option value="08">8</option><option value="09">9</option><option value="10">10</option>
                        <option value="11">11</option><option value="12">12</option><option value="13">13</option><option value="14">14</option><option value="15">15</option>
                        <option value="16">16</option><option value="17">17</option><option value="18">18</option><option value="19">19</option><option value="20">20</option>
                        <option value="21">21</option><option value="22">22</option><option value="23">23</option><option value="24">24</option><option value="25">25</option>
                        <option value="26">26</option><option value="27">27</option><option value="28">28</option><option value="29">29</option><option value="30">30</option>
                        <option value="31">31</option>
                    </select>
                </div>
                <div style="display:flex; flex-direction:column; justify-content:center; margin-right:10px;">
    <label style="font-size:11px; font-weight:bold; color:#d32f2f; cursor:pointer; display:flex; align-items:center; background:#ffebee; padding:4px 8px; border-radius:4px; border:1px solid #ffcdd2;">
        <input type="checkbox" id="filtroConSalida" style="margin-right:6px;">
        Solo con Fecha Salida (Proyecci√≥n)
    </label>
</div>

                <button onclick="limpiarFiltrosPresupuesto()" class="btn btn-secondary" style="font-size:11px; padding:6px 12px; height: 30px;">
                    <i class="fa-solid fa-eraser"></i> Limpiar
                </button>
            </div>
        </div>

        <div style="display:flex; gap:10px;">
            <div style="text-align:right; background:#e3f2fd; padding:10px 15px; border-radius:8px; min-width:140px;">
                <div style="font-size:10px; color:#007dc5; font-weight:bold; text-transform:uppercase;">Facturaci√≥n (Subtotal)</div>
                <div id="granTotalDisplay" style="font-size:20px; font-weight:800; color:#007dc5;">$ 0.00</div>
            </div>

            <div style="text-align:right; background:#e8f5e9; padding:10px 15px; border-radius:8px; border:1px solid #c8e6c9; min-width:160px;">
                <div style="font-size:10px; color:#2e7d32; font-weight:bold; text-transform:uppercase;">Facturaci√≥n + IVA (15%)</div>
                <div id="granTotalIvaDisplay" style="font-size:20px; font-weight:800; color:#2e7d32;">$ 0.00</div>
            </div>
        </div>
    </div>

    <div class="auditoria-container" style="max-height: none;">
      <table id="tablaPresupuestoGeneral" style="width:100%; border-collapse:collapse; font-size:13px;">
        <thead style="background:#f1f5f9; color:#334155;">
            <tr>
                <th style="padding:10px; text-align:left;">Sector / Rubro</th>
                <th style="padding:10px; text-align:right; color:#007dc5;">Ingresos SEGUROS</th>
                <th style="padding:10px; text-align:right; color:#2e7d32;">Ingresos PRIVADOS</th>
                <th style="padding:10px; text-align:right; font-weight:800;">TOTAL RUBRO</th>
            </tr>
        </thead>
        <tbody id="bodyPresupuestoGeneral"></tbody>
        <tfoot style="background:#f8fafc; font-weight:bold; border-top:2px solid #e2e8f0;">
            <tr>
                <td style="padding:12px;">TOTALES</td>
                <td style="padding:12px; text-align:right;" id="footSeguro">$ 0.00</td>
                <td style="padding:12px; text-align:right;" id="footPrivado">$ 0.00</td>
                <td style="padding:12px; text-align:right;" id="footTotal">$ 0.00</td>
            </tr>
        </tfoot>
      </table>
    </div>
  </div>
</section>
  <section id="view-detalle" class="view" style="padding:10px;">
    <div class="panel-detalle">
      <div class="detalle-header-actions">
        <button id="btnVolverDesdeDetalle" class="btn btn-link">&larr; Volver al tablero</button>
        <div style="display:flex;gap:8px;flex-wrap:wrap;">
          <button id="btnEditarVehiculo" class="btn btn-secondary">Editar datos</button>
          <button id="btnEliminarVehiculo" class="btn btn-danger">Eliminar veh√≠culo</button>
        </div>
      </div>
      <h2 id="detalle-titulo">Detalle del veh√≠culo</h2>
      <small id="detalle-subtitulo"></small>
      <div class="detalle-grid">
        <div><span class="detalle-label">VIN:</span> <span id="detalle-vin" class="detalle-value"></span></div>
        <div><span class="detalle-label">Placa:</span> <span id="detalle-placa" class="detalle-value"></span></div>
        <div><span class="detalle-label">Modelo:</span> <span id="detalle-modelo" class="detalle-value"></span></div>
        <div><span class="detalle-label">Propietario:</span> <span id="detalle-propietario" class="detalle-value"></span></div>
        <div><span class="detalle-label">C√©dula:</span> <span id="detalle-cedula" class="detalle-value"></span></div>
        <div><span class="detalle-label">Aseguradora:</span> <span id="detalle-aseguradora" class="detalle-value"></span></div>
        <div><span class="detalle-label">Asesor:</span> <span id="detalle-asesor" class="detalle-value"></span></div>
        <div><span class="detalle-label">T√©cnico encargado:</span> <span id="detalle-tecnico" class="detalle-value"></span></div>
        <div><span class="detalle-label">Fecha ingreso:</span> <span id="detalle-fecha-ingreso" class="detalle-value"></span></div>
        <div><span class="detalle-label">Fecha tentativa salida:</span> <span id="detalle-fecha-salida" class="detalle-value"></span></div>
        <div><span class="detalle-label">Hora entrega:</span> <span id="detalle-hora-salida" class="detalle-value"></span></div>
        <div><span class="detalle-label">Estado actual:</span> <span id="detalle-estado" class="detalle-value"></span></div>
      </div>
      <div class="detalle-subsection-title">Partes afectadas</div><ul id="detalle-danos" class="detalle-list"></ul>
      <div class="detalle-subsection-title">Equipamiento presente</div><ul id="detalle-equipamiento" class="detalle-list"></ul>
      <div class="detalle-subsection-title">Orden de trabajo adjunta</div><div id="detalle-archivo" class="detalle-archivo" style="font-size:12px;color:#555;margin-top:4px;"></div>
      <div class="detalle-subsection-title">Datos del cliente</div><div id="detalle-archivos-cliente" class="detalle-archivo"></div>
      <div class="detalle-subsection-title">Autorizaciones</div><div id="detalle-archivos-autorizaciones" class="detalle-archivo"></div>
      <div class="detalle-subsection-title">Proformas y fotos</div><div id="detalle-archivos-proformas" class="detalle-archivo"></div>

      <div class="detalle-subsection-title">Presupuesto y repuestos</div>
      <div id="presupuesto-resumen" class="presupuesto-resumen">No hay √≠tems de presupuesto registrados.</div>
      <div class="presupuesto-table">
        <div class="presupuesto-header-row"><div>Tipo / Grupo</div><div>C√≥digo</div><div>Descripci√≥n</div><div>Cant.</div><div class="presupuesto-importes">Valor</div></div>
        <div id="presupuesto-list"></div>
      </div>
      <form id="presupuestoForm">
        <div class="presupuesto-form-inline">
          <select id="presupuesto_tipo"><option value="Seguro">Seguro</option><option value="Privado">Privado</option></select>
          <select id="presupuesto_categoria"><option value="Repuesto">Repuesto</option><option value="Mano de obra">Mano de obra</option><option value="Servicio tercero">Servicio tercero</option></select>
          <input id="presupuesto_codigo" type="text" placeholder="C√≥digo" />
          <input id="presupuesto_desc" type="text" placeholder="Descripci√≥n" />
          <input id="presupuesto_cant" type="number" min="1" step="1" placeholder="Cant." />
          <input id="presupuesto_valor" type="number" min="0" step="0.01" placeholder="Valor" />
        </div>
        <div class="presupuesto-form-actions"><button type="submit" class="btn btn-secondary" style="font-size:11px;padding:4px 10px;">Agregar √≠tem</button></div>
      </form>

      <div class="ordenes-header">
        <h3 style="margin:0;font-size:14px;">√ìrdenes de trabajo (anotaciones)</h3>
        <small>Doble clic en una tarjeta del tablero para ver y agregar √≥rdenes.</small>
      </div>
      <div id="ordenesList" class="ordenes-list"></div>
      <form id="ordenForm">
        <div class="form-grid"><div class="form-field" style="grid-column: span 2;"><label for="orden_descripcion">Descripci√≥n de la orden *</label><textarea id="orden_descripcion" name="orden_descripcion" rows="2" placeholder="Ej: Cambio de parachoques delantero, alineaci√≥n..." required></textarea></div></div>
        <div class="form-actions"><div class="form-actions-right"><button type="submit" class="btn btn-primary">Agregar orden</button></div></div>
      </form>
    </div>
  </section>
</div>

<section id="view-lavador" class="view" style="padding: 16px;">
    <div class="lavador-header">
        <div>
            <h2 style="margin:0;"><i class="fa-solid fa-soap"></i> AXTROM Lavadora</h2>
            <span style="font-size:12px; opacity:0.9;">Panel de Control de Operario</span>
        </div>
        <div>
            <span id="lavadorUserDisplay" style="font-weight:bold; margin-right:15px;"></span>
            <button id="btnLogoutLavador" class="btn btn-danger"><i class="fa-solid fa-right-from-bracket"></i> Salir</button>
        </div>
    </div>
    
    <div class="lavador-board">
        <div class="lavador-column">
            <div class="column-title"><i class="fa-solid fa-clock"></i> EN ESPERA</div>
            <div id="lav-list-espera"></div>
        </div>
        <div class="lavador-column">
            <div class="column-title"><i class="fa-solid fa-water"></i> LAVANDO</div>
            <div id="lav-list-lavando"></div>
        </div>
        <div class="lavador-column">
            <div class="column-title"><i class="fa-solid fa-wind"></i> SECADO / ASPIRADO</div>
            <div id="lav-list-secado"></div>
        </div>
        <div class="lavador-column">
            <div class="column-title" style="color: #4caf50;"><i class="fa-solid fa-check-double"></i> LISTO</div>
            <div id="lav-list-listo"></div>
        </div>
    </div>
</section>

<script>
// =========================================
// 1. CONFIGURACI√ìN DE USUARIOS (Parte Superior)
// =========================================
let usuariosSistema = [
    { id: 1, nombre: "Jhonathan Cevallos", usuario: "jcevallos", rol: "admin", password: "12345", activo: true },
    { id: 5, nombre: "Ronald Sanchez", usuario: "rsanchez", rol: "admin", password: "12345", activo: true },
    { id: 2, nombre: "Pablo Le√≥n", usuario: "pleon", rol: "admin", password: "12345", activo: true },
    { id: 3, nombre: "Magno Hugo", usuario: "mhugo", rol: "admin", password: "12345", activo: true },
    { id: 4, nombre: "Marcos Ibarra", usuario: "mibarra", rol: "admin", password: "12345", activo: true },
    { id: 10, nombre: "Angel Anguisaca", usuario: "aanguisaca", rol: "tecnico", password: "12345", activo: true },
    { id: 11, nombre: "Carlos Cajamarca", usuario: "ccajamarca", rol: "tecnico", password: "12345", activo: true },
    { id: 12, nombre: "Diego Campoverde", usuario: "dcampoverde", rol: "tecnico", password: "12345", activo: true },
    { id: 13, nombre: "Juan Eras", usuario: "jeras", rol: "tecnico", password: "12345", activo: true },
    { id: 14, nombre: "Jorge Sanchez", usuario: "jsanchez", rol: "tecnico", password: "12345", activo: true },
    { id: 15, nombre: "Tecnico Tot", usuario: "ttot", rol: "tecnico", password: "12345", activo: true },
    { id: 16, nombre: "Externo", usuario: "externo1", rol: "tecnico", password: "12345", activo: true },
    { id: 17, nombre: "Roman Saca", usuario: "rsaca", rol: "tecnico", password: "12345", activo: true },
    { id: 99, nombre: "Operario Lavado", usuario: "lavado", rol: "lavador", password: "1234", activo: true }
];

// ESTA L√çNEA ES VITAL: Fuerza la actualizaci√≥n de los datos viejos del navegador
localStorage.setItem("proauto_usuarios", JSON.stringify(usuariosSistema));

const PERMISOS = {
  admin: { mover: true, editarVehiculo: true, eliminarVehiculo: true, agregarOT: true, editarPresupuesto: true },
  asesor: { mover: true, editarVehiculo: true, eliminarVehiculo: false, agregarOT: true, editarPresupuesto: true },
  tecnico: { mover: true, editarVehiculo: false, eliminarVehiculo: false, agregarOT: false, editarPresupuesto: false },
  lavador: { mover: true, editarVehiculo: false, eliminarVehiculo: false, agregarOT: false, editarPresupuesto: false }
};

const STATUS_COLUMNS = [
   { id: "falta_inspeccion", label: "Falta de inspecci√≥n" },
   { id: "falta_autorizacion", label: "Falta de autorizaci√≥n" },
   { id: "autorizado", label: "Autorizado" },
   { id: "espera_servicio", label: "Espera servicio" },
   { id: "enderezado", label: "Enderezado" },
   { id: "preparado", label: "Preparado" },
   { id: "pintura", label: "Pintura" },
   // AQUI ESTA LA COLUMNA DE LAVADO QUE SE VOLVERA VERTICAL
   { id: "en_lavado", label: "En lavado (Subfases)" },
   { id: "listo", label: "Control de Calidad" }, 
   { id: "entregado", label: "Entregado" },
   { id: "perdida_total", label: "P√©rdida total" },
   { id: "facturados", label: "Veh√≠culos Facturados ‚è≥" }
];
const STATUS_ICONS = {
  falta_inspeccion: "fa-magnifying-glass", falta_autorizacion: "fa-circle-xmark", autorizado: "fa-circle-check",
  espera_servicio: "fa-clock", enderezado: "fa-screwdriver-wrench", preparado: "fa-layer-group", pintura: "fa-spray-can",
  listo: "fa-check-double", en_lavado: "fa-water", entregado: "fa-truck", perdida_total: "fa-triangle-exclamation"
};

let vehicles = [
];

let auditoria = [];
let currentUser = null;
// =========================================
// üîî SISTEMA DE NOTIFICACIONES (PEGAR AL INICIO DEL SCRIPT)
// =========================================
let notificaciones = JSON.parse(localStorage.getItem("axtrom_notificaciones") || "[]");

function crearNotificacion(rolDestino, usuarioDestino, mensaje) {
    const nuevaNotif = {
        id: Date.now(),
        fecha: new Date().toLocaleString(),
        rolDestino: rolDestino,
        usuarioDestino: usuarioDestino,
        mensaje: mensaje,
        leida: false
    };
    notificaciones.push(nuevaNotif);
    
    // üëá ESTO ES VITAL: GUARDAR CAMBIOS INMEDIATAMENTE PARA QUE SUBA A LA NUBE
    if(typeof guardarCambios === "function") {
        guardarCambios();
    } else {
        // Fallback si no existe la funci√≥n a√∫n
        localStorage.setItem("axtrom_notificaciones", JSON.stringify(notificaciones));
    }
    
    checkNotificaciones(); 
}

// 2. Funci√≥n para revisar y mostrar notificaciones
// ==========================================
// üîî FUNCI√ìN CORREGIDA: CHECK NOTIFICACIONES
// ==========================================
function checkNotificaciones() {
    if(!currentUser || currentUser.rol === "lavador") return;

    const badge = document.getElementById("notifBadge");
    const list = document.getElementById("notifList");
    
    // Filtro inteligente (Ignora may√∫sculas/min√∫sculas)
    const misNotif = notificaciones.filter(n => {
        if(n.leida) return false;
        
        // 1. Si soy Admin/Asesor -> Veo todo lo de asesores
        if (currentUser.rol === "admin" || currentUser.rol === "asesor") {
            return n.rolDestino === "asesor";
        }
        
        // 2. Si soy T√©cnico -> Veo lo m√≠o (Comparaci√≥n insensible a may√∫sculas)
        if (currentUser.rol === "tecnico" && n.rolDestino === "tecnico") {
            const destino = (n.usuarioDestino || "").toUpperCase();
            const yo = (currentUser.nombre || "").toUpperCase();
            return destino === yo;
        }
        return false;
    });

    // Badge Rojo
    if (badge) {
        badge.textContent = misNotif.length;
        badge.style.display = misNotif.length > 0 ? "flex" : "none";
    }

    // Renderizar Lista
    if (list) {
        list.innerHTML = "";
        // Filtramos para el historial visual tambi√©n
        const historial = notificaciones.filter(n => {
            if (currentUser.rol === "admin" || currentUser.rol === "asesor") return n.rolDestino === "asesor";
            if (currentUser.rol === "tecnico") {
                const destino = (n.usuarioDestino || "").toUpperCase();
                const yo = (currentUser.nombre || "").toUpperCase();
                return n.rolDestino === "tecnico" && destino === yo;
            }
            return false;
        }).reverse().slice(0, 10);

        if(historial.length === 0) list.innerHTML = "<div style='padding:10px;color:#999;text-align:center;'>Sin notificaciones</div>";
        
        historial.forEach(n => {
            const div = document.createElement("div");
            div.className = "notif-item " + (n.leida ? "" : "unread");
            div.innerHTML = `<span style="font-weight:bold;">${n.mensaje}</span><span class="notif-time">${n.fecha}</span>`;
            list.appendChild(div);
        });
    }
}



// =========================================
// 2. SISTEMA DE LOGIN, RUTAS Y PERMISOS (BLOQUE MAESTRO)
// =========================================
function loginSistema() {
    currentUser = null;
    const usuarioIngresado = document.getElementById("loginUsuario").value.trim();
    const passwordIngresado = document.getElementById("loginPassword").value.trim();
    
    // Leemos siempre la lista fresca que acabamos de guardar en Parte 1
    let lista = JSON.parse(localStorage.getItem("proauto_usuarios"));
    const encontrado = lista.find(u => u.usuario === usuarioIngresado && u.password === passwordIngresado && u.activo);

    if (!encontrado) { alert("Usuario o contrase√±a incorrectos."); return; }

    // Asignamos usuario globalmente
    currentUser = encontrado;
    window.currentUser = encontrado; 

    // Limpiamos campos y ocultamos login
    document.getElementById("loginUsuario").value = "";
    document.getElementById("loginPassword").value = "";
    document.getElementById("loginScreen").style.display = "none";
    if(typeof cargarDatosDeNube === "function") {
        console.log("Conectando con Google Sheets...");
        cargarDatosDeNube(); // Descarga inmediata
        
        // Activar auto-actualizaci√≥n cada 30 segundos
        setInterval(() => {
            console.log("Sincronizando cambios...");
            cargarDatosDeNube();
        }, 30000);
    }
    // RUTAS SEGUN ROL
    if (currentUser.rol === "lavador") {
        document.getElementById("main-container").style.display = "none";
        document.getElementById("view-lavador").style.display = "block";
        document.getElementById("lavadorUserDisplay").textContent = "OPERARIO: " + currentUser.nombre;
        renderLavadorView();
    } else {
        document.getElementById("view-lavador").style.display = "none";
        document.getElementById("main-container").style.display = "block";
        
        // Carga segura del tablero
        try {
            showView("tablero");
            // Intentamos cargar notificaciones si la funci√≥n existe
            if(typeof checkNotificaciones === "function") checkNotificaciones();
            mostrarInfoUsuario();
            aplicarPermisosEnInterfaz(); 
            renderBoard(); 
        } catch (error) {
            console.error("Error cargando perfil:", error);
            alert("Error al cargar perfil. Intente recargar la p√°gina.");
        }
    }
}

function logout() {
  currentUser = null;
  window.currentUser = null;
  
  // Ocultar info de usuario y limpiar tablero visualmente
  const userBox = document.getElementById("userInfoBox");
  if(userBox) userBox.style.display = "none";
  
  const boardEl = document.getElementById("board");
  if(boardEl) boardEl.innerHTML = ""; // Limpieza visual

  document.querySelectorAll(".view").forEach(v => v.classList.remove("active"));
  document.getElementById("view-lavador").style.display = "none";
  document.getElementById("main-container").style.display = "block"; 
  document.getElementById("loginScreen").style.display = "flex";
  
  // Limpiar buscador
  const searchInput = document.getElementById("searchInput");
  if(searchInput) searchInput.value = "";
  
  showView("login");
}

// Listeners de Login
document.getElementById("btnLogin").onclick = loginSistema;
document.getElementById("loginPassword").addEventListener("keypress", function(event) {
  if (event.key === "Enter") {
    loginSistema();
  }
});
document.getElementById("btnLogout").onclick = logout;
document.getElementById("btnLogoutLavador").onclick = logout;

function showView(name) {
    if(currentUser && currentUser.rol === "lavador") return;
    
    document.querySelectorAll(".view").forEach(v => v.classList.remove("active"));
    
    const viewMap = {
        "login": "view-login",
        "tablero": "view-tablero",
        "form": "view-form",
        "detalle": "view-detalle",
        "auditoria": "view-auditoria",
        "presupuesto": "view-presupuesto"
    };

    const id = viewMap[name];
    if(id) {
        const el = document.getElementById(id);
        if(el) el.classList.add("active");
    }
}

function aplicarPermisosEnInterfaz() {
    if(!currentUser) return;
    const role = currentUser.rol;

    const btnAuditoria = document.getElementById("btnAuditoria");
    const btnAgregar   = document.getElementById("btnAgregarVehiculo");
    const btnEditar    = document.getElementById("btnEditarVehiculo");
    const btnEliminar  = document.getElementById("btnEliminarVehiculo");
    const btnPresupuesto = document.getElementById("btnPresupuesto");
    const presupuestoForm = document.getElementById("presupuestoForm");

    // Reset: Mostrar todo primero (por defecto Admin/Asesor)
    if(btnAgregar) btnAgregar.style.display = "inline-block";
    if(btnEditar) btnEditar.style.display = "inline-block";
    if(btnEliminar) btnEliminar.style.display = "inline-block";
    if(btnPresupuesto) btnPresupuesto.style.display = "inline-block";
    
    // Auditor√≠a solo Admin
    if(btnAuditoria) btnAuditoria.style.display = (role === "admin") ? "inline-block" : "none";

    // Restricciones T√âCNICO
    if (role === "tecnico") {
        if(btnAgregar) btnAgregar.style.display = "none";
        if(btnEditar) btnEditar.style.display = "none";
        if(btnEliminar) btnEliminar.style.display = "none";
        if(btnPresupuesto) btnPresupuesto.style.display = "none";
        if(presupuestoForm) presupuestoForm.style.display = "none";
        
        // Ocultar botones peque√±os en tablas internas
        setTimeout(() => {
            document.querySelectorAll(".presupuesto-btn-edit, .presupuesto-btn-delete").forEach(b => b.style.display = "none");
        }, 200);
    }
}

function mostrarInfoUsuario() {
    const box = document.getElementById("userInfoBox");
    const name = document.getElementById("userInfoName");
    const role = document.getElementById("userInfoRole");
    
    if (currentUser) {
        name.textContent = currentUser.nombre;
        role.textContent = currentUser.rol.toUpperCase();
        box.style.display = "block";
    } else { 
        box.style.display = "none"; 
    }
}

// =========================================
// RENDERIZADO TABLERO PRINCIPAL (MODIFICADO PARA LAVADORA VERTICAL)
// =========================================
const board = document.getElementById("board");
let draggedCardId = null;



// ===============================================
// üîß CORRECCI√ìN: TABLERO (M.O. INCLUYE 'OTROS')
// ===============================================
function renderBoard() {
  // 1. Vista exclusiva para Lavador
  if (currentUser && currentUser.rol === "lavador") { 
      renderLavadorView(); 
      return; 
  }

  const board = document.getElementById("board");
  if (!board) return;
  board.innerHTML = "";

  const q = (document.getElementById("searchInput").value || "").toLowerCase().trim();
  
  // 2. Filtrado inicial por b√∫squeda
  let data = q ? vehicles.filter(v => 
      [v.placa, v.modelo, v.propietario, v.vin].some(c => c && c.toLowerCase().includes(q))
  ) : vehicles;

  // 3. L√ìGICA DE ROLES (FILTRADO VISUAL)
  let columnasVisibles = STATUS_COLUMNS; 

  if (currentUser && currentUser.rol === "tecnico") {
      // T√©cnico: Solo ve Producci√≥n + Salida
      const permitidas = ["enderezado", "preparado", "pintura", "listo"];
      columnasVisibles = STATUS_COLUMNS.filter(c => permitidas.includes(c.id));

      // T√©cnico: Solo ve sus propios veh√≠culos asignados
      const miNombre = (currentUser.nombre || "").toUpperCase();
      data = data.filter(v => {
          const tecnicoAsignado = (v.tecnico || "").toUpperCase();
          return tecnicoAsignado === miNombre;
      });
  }

  // 4. RENDERIZADO DE COLUMNAS
  columnasVisibles.forEach(col => {
    const columnEl = document.createElement("div");
    columnEl.className = "column";

    // --- HEADER DE LA COLUMNA ---
    const headerEl = document.createElement("div");
    headerEl.className = "column-header";
    const titleEl = document.createElement("div");
    titleEl.className = "column-title";
    titleEl.innerHTML = `<i class="fa-solid ${STATUS_ICONS[col.id] || "fa-circle"}"></i> ${col.label}`;
    
    // Filtramos los veh√≠culos de ESTA columna
    const vehiculosEnColumna = data.filter(v => v.estado === col.id);
    
    const countEl = document.createElement("div");
    countEl.className = "column-count";
    countEl.textContent = vehiculosEnColumna.length;
    
    headerEl.appendChild(titleEl);
    headerEl.appendChild(countEl);
    columnEl.appendChild(headerEl);

    // --- üí∞ DESGLOSE DE DINERO (M.O. + OTROS vs REPUESTOS) ---
    let totalMO = 0;   // Enderezado + Pintura + OTROS
    let totalRep = 0;  // Repuestos

    vehiculosEnColumna.forEach(v => {
        const p = v.presupuestoDesglose || {};
        
        // 1. Sumar Mano de Obra (Enderezado + Pintura + Otros)
        totalMO += (Number(p['seg_enderezado_v']) || 0) + 
                   (Number(p['seg_pintura_v']) || 0) + 
                   (Number(p['seg_otros_v']) || 0) +     // <-- Agregado Otros (Seguro)
                   (Number(p['priv_enderezado_v']) || 0) + 
                   (Number(p['priv_pintura_v']) || 0) +
                   (Number(p['priv_otros_v']) || 0);     // <-- Agregado Otros (Privado)

        // 2. Sumar Repuestos
        totalRep += (Number(p['seg_repuestos_v']) || 0) + 
                    (Number(p['priv_repuestos_v']) || 0);
    });

    // üîí CANDADO DE SEGURIDAD
    // Solo mostramos si hay dinero Y el usuario NO es t√©cnico
    if ((totalMO > 0 || totalRep > 0) && currentUser.rol !== "tecnico") {
        const moneyContainer = document.createElement("div");
        moneyContainer.style.cssText = "text-align: right; font-size: 10px; font-weight: 700; margin-top: -6px; margin-bottom: 8px; padding-right: 2px; line-height: 1.3;";
        
        const fmt = (n) => n.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});

        moneyContainer.innerHTML = `
            <div style="color: #007dc5;">M.O: $ ${fmt(totalMO)}</div>
            <div style="color: #e65100;">Rep: $ ${fmt(totalRep)}</div>
        `;
        columnEl.appendChild(moneyContainer);
    }

    // --- DROPZONE (√ÅREA DE TARJETAS) ---
    const dropzone = document.createElement("div");
    dropzone.className = "dropzone";
    dropzone.dataset.status = col.id;
    dropzone.addEventListener("dragover", handleDragOver);
    dropzone.addEventListener("dragleave", handleDragLeave);
    dropzone.addEventListener("drop", handleDrop);

    // L√ìGICA ESPECIAL LAVADO (VERTICAL)
    if(col.id === "en_lavado") {
        const subFases = ["espera", "lavando", "secado", "listo"];
        const subLabels = { espera: "EN ESPERA", lavando: "LAVANDO", secado: "SECADO/ASPIRADO", listo: "LISTO P/ ENTREGA" };
        const containerV = document.createElement("div");
        containerV.className = "lavado-subzone-container";

        subFases.forEach(fase => {
            const subDiv = document.createElement("div");
            subDiv.className = "lavado-subzone";
            subDiv.innerHTML = `<div class="lavado-subzone-title">${subLabels[fase]}</div>`;
            vehiculosEnColumna.filter(v => (v.lavado_status || "espera") === fase).forEach(vehicle => {
                const card = createCard(vehicle);
                subDiv.appendChild(card);
            });
            containerV.appendChild(subDiv);
        });
        dropzone.appendChild(containerV);
    } else {
        // COLUMNA STANDARD
        vehiculosEnColumna.forEach(vehicle => {
            const card = createCard(vehicle);
            dropzone.appendChild(card);
        });
    }

    columnEl.appendChild(dropzone);
    board.appendChild(columnEl);
  });
}

// =========================================
// TARJETAS Y DRAG & DROP (ORIGINAL + LAVADORA LOGIC)
// =========================================
function createCard(vehicle) {
  const card = document.createElement("div");
  card.className = "card";
  card.draggable = true;
  card.dataset.id = vehicle.id;
  card.addEventListener("click", () => showVehicleSummary(vehicle));
  card.addEventListener("dragstart", handleDragStart);
  card.addEventListener("dragend", handleDragEnd);
  card.addEventListener("dblclick", () => openVehicleDetail(vehicle.id));

  const top = document.createElement("div");
  top.className = "card-top";
  top.innerHTML = `<div class="plate">${vehicle.placa}</div><div class="brand">${vehicle.modelo}</div>`;
  card.appendChild(top);

  const chipsLine = document.createElement("div");
  if(vehicle.aseguradora) chipsLine.innerHTML += `<span class="chip insurer">${vehicle.aseguradora}</span>`;
  chipsLine.innerHTML += `<span class="chip-client">${vehicle.propietario}</span>`;
  if(vehicle.asesor) chipsLine.innerHTML += `<span class="chip chip-small">Asesor: ${vehicle.asesor}</span>`;
  card.appendChild(chipsLine);

  // Ultima OT
  const ultimaOrden = vehicle.ordenes?.length ? vehicle.ordenes[vehicle.ordenes.length - 1] : null;
  if (ultimaOrden) {
    const ot = document.createElement("div");
    ot.className = "card-ot";
    ot.textContent = "OT: " + ultimaOrden.descripcion;
    card.appendChild(ot);
  }

  const extra = document.createElement("div");
  extra.className = "card-extra";
  extra.innerHTML = `<span class="card-extra-item"><i class="fa-solid fa-user-gear"></i> ${vehicle.tecnico || "‚Äî"}</span>
                     <span class="card-extra-item"><i class="fa-solid fa-id-card-clip"></i> ${vehicle.cedula || "‚Äî"}</span>
                     <span class="card-extra-item"><i class="fa-solid fa-calendar-day"></i> ${vehicle.fecha_salida || "‚Äî"}</span>`;
  card.appendChild(extra);
  return card;
}

function handleDragStart(e) { draggedCardId = Number(e.target.dataset.id); e.target.classList.add("dragging"); e.dataTransfer.effectAllowed = "move"; }
function handleDragEnd(e) { e.target.classList.remove("dragging"); }
function handleDragOver(e) { e.preventDefault(); e.currentTarget.classList.add("over"); e.dataTransfer.dropEffect = "move"; }
function handleDragLeave(e) { e.currentTarget.classList.remove("over"); }

function handleDrop(e) {
    e.preventDefault();
    const dropzone = e.target.closest(".dropzone"); 
    if(!dropzone) return;
    
    dropzone.classList.remove("over");
    const newStatus = dropzone.dataset.status;
    const vehicle = vehicles.find(v => v.id == draggedCardId);
    if (!vehicle) return;
    const oldStatus = vehicle.estado;

    // VALIDACION TECNICOS
    if (window.currentUser && window.currentUser.rol === "tecnico") {
        const columnasTecnico = ["enderezado", "preparado", "pintura", "listo"];
        if (!columnasTecnico.includes(oldStatus) || !columnasTecnico.includes(newStatus)) {
            alert("No tienes permiso para mover veh√≠culos fuera de producci√≥n."); return;
        }
        const orden = { enderezado: 1, preparado: 2, pintura: 3, listo: 4 };
        if (orden[newStatus] < orden[oldStatus]) { alert("No tienes permiso para retroceder un veh√≠culo."); return; }
    }

    // 1. CAMBIAR ESTADO
    vehicle.estado = newStatus;
    
    if (window.currentUser && window.currentUser.rol === "tecnico") {
        crearNotificacion("asesor", null, `El t√©cnico ${window.currentUser.nombre} movi√≥ el veh√≠culo ${vehicle.placa} a ${newStatus.toUpperCase()}`);
    }

    // 2. NUEVO: NOTIFICACI√ìN AL T√âCNICO (Si mueve un Admin/Asesor)
    // Solo si el carro tiene t√©cnico asignado y quien mueve NO es ese t√©cnico
    if (window.currentUser.rol !== "tecnico" && vehicle.tecnico) {
        crearNotificacion("tecnico", vehicle.tecnico, `‚ö†Ô∏è Taller: ${window.currentUser.nombre} movi√≥ tu asignaci√≥n ${vehicle.placa} a ${newStatus.toUpperCase()}`);
    }
    // AGREGAR ESTO:
    if (newStatus === "facturados") {
        vehicle.fecha_facturado = Date.now(); // Marca de tiempo de inicio
    }

    // 3. L√ìGICA LAVADORA
    if(newStatus === "en_lavado" && oldStatus !== "en_lavado") {
        vehicle.lavado_status = "espera";
    }

    // 4. AUDITOR√çA
    const ahora = new Date();
    auditoria.push({
        fecha: ahora.toISOString().slice(0, 10), hora: ahora.toTimeString().slice(0, 8),
        usuario: window.currentUser.nombre, placa: vehicle.placa, desde: STATUS_COLUMNS.find(s=>s.id===oldStatus)?.label, hacia: STATUS_COLUMNS.find(s=>s.id===newStatus)?.label, accion: "Movimiento", descripcion: `Movido por ${currentUser.nombre}`
    });
    
    draggedCardId = null;

    // 5. VENTANA EMERGENTE DE COSTOS
    if (newStatus === "autorizado") {
        abrirModalPresupuesto(vehicle.id);
    }

    // 6. GUARDAR EN LA NUBE Y RENDERIZAR
    guardarCambios(); 
    renderBoard();
}

function renderLavadorView() {
    ["espera","lavando","secado","listo"].forEach(st => {
        const div = document.getElementById("lav-list-"+st);
        if(div) div.innerHTML = "";
        
        vehicles.filter(v => v.estado === "en_lavado" && (v.lavado_status || "espera") === st).forEach(v => {
            const card = document.createElement("div"); card.className = "lavador-card";
            card.innerHTML = `<div style="font-weight:bold;font-size:18px;">${v.placa}</div><div style="font-size:12px;">${v.modelo}</div>`;
            
            const btnNext = document.createElement("button"); 
            btnNext.className = "btn btn-primary"; 
            btnNext.style.marginTop = "8px"; 
            btnNext.style.width = "100%";
            btnNext.innerHTML = 'Siguiente <i class="fa-solid fa-arrow-right"></i>';
            
            btnNext.onclick = () => {
                const nextMap = { espera: "lavando", lavando: "secado", secado: "listo", listo: "fin" };
                const next = nextMap[st];
                
                if(next === "fin") {
                    if(confirm("¬øConfirmar que el veh√≠culo est√° listo para entrega?")) {
                        v.estado = "entregado";
                        // NOTIFICACI√ìN FINAL
                        crearNotificacion("asesor", null, `‚úÖ Lavado COMPLETADO: ${v.placa} listo para entrega.`);
                    }
                } else {
                    v.lavado_status = next;
                    // üëá NOTIFICACI√ìN DE PROGRESO üëá
                    crearNotificacion("asesor", null, `üöø Lavado: ${v.placa} pas√≥ a fase ${next.toUpperCase()}`);
                }
                renderLavadorView();
            };
            card.appendChild(btnNext);
            if(div) div.appendChild(card);
        });
    });
}
function moverLavadora(id, nuevoSubEstado) {
    const v = vehicles.find(x => x.id === id);
    if(v) { v.lavado_status = nuevoSubEstado; renderLavadorView(); }
}
function sacarDeLavadora(id) {
    const v = vehicles.find(x => x.id === id);
    if(v && confirm(`¬øFinalizar lavado y mover ${v.placa} a CONTROL DE CALIDAD?`)) {
        v.estado = "listo"; 
        renderLavadorView();
    }
}

// =========================================
// FUNCIONALIDADES ORIGINALES RESTAURADAS (ARCHIVOS, PRESUPUESTOS, OT)
// =========================================
const form = document.getElementById("vehicleForm");
const btnAgregarVehiculo = document.getElementById("btnAgregarVehiculo");
const btnCancelarForm = document.getElementById("btnCancelarForm");
let editingVehicleId = null;

function resetFormSelectionGroups() {
    document.querySelectorAll('input[name="danos"]').forEach(chk => chk.checked = false);
    document.querySelectorAll('input[name="equipamiento"]').forEach(chk => chk.checked = false);
}

// Manejo de Archivos Base64
async function procesarArchivosMultiple(inputId) {
  const input = document.getElementById(inputId);
  if (!input || !input.files || input.files.length === 0) return [];
  const archivos = [];
  for (const file of input.files) {
    const base64 = await convertirArchivoABase64(file);
    archivos.push({ nombre: file.name, tipo: file.type, base64 });
  }
  return archivos;
}
function convertirArchivoABase64(file) {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onload = () => resolve(reader.result);
    reader.onerror = reject;
    reader.readAsDataURL(file);
  });
}

// Formulario Veh√≠culo
btnAgregarVehiculo.addEventListener("click", () => {
    editingVehicleId = null; form.reset(); resetFormSelectionGroups(); showView("form");
});
btnCancelarForm.addEventListener("click", () => showView("tablero"));

// ===============================================
// üîß FORMULARIO: ASIGNACI√ìN CON √ÅREA (FINAL)
// ===============================================
form.addEventListener("submit", async function (e) {
  e.preventDefault();
  const formData = new FormData(form);

  // 1. Obtener datos b√°sicos
  const placa = (formData.get("placa") || "").trim();
  const modelo = (formData.get("modelo") || "").trim();
  const propietario = (formData.get("propietario") || "").trim();
  const cedula = (formData.get("cedula") || "").trim();
  const vin = (formData.get("vin") || "").trim();
  const aseguradora = formData.get("aseguradora") || "";
  const asesor = (formData.get("asesor") || "").trim();
  const tecnico = formData.get("tecnico") || "";
  const fecha_ingreso = formData.get("fecha_ingreso") || "";
  const fecha_salida = formData.get("fecha_salida") || "";
  const hora_salida = formData.get("hora_salida") || "";
  
  if (!placa || !modelo || !propietario) {
    alert("Placa, modelo y propietario son obligatorios.");
    return;
  }

  const danos = formData.getAll("danos");
  const equipamiento = formData.getAll("equipamiento");

  // 2. Procesar Archivos
  const archivosCliente = await procesarArchivosMultiple("archivos_cliente");
  const archivosAutorizaciones = await procesarArchivosMultiple("archivos_autorizaciones");
  const archivosProformas = await procesarArchivosMultiple("archivos_proformas");

  const archivoInput = document.getElementById("archivo_orden");
  const file = archivoInput?.files?.[0] || null;
  let archivoOrden = null;
  if (file) {
    const base64 = await convertirArchivoABase64(file);
    archivoOrden = { nombre: file.name, tipo: file.type, base64 };
  }

  // Helper para obtener el nombre bonito del √°rea (ej: "falta_inspeccion" -> "Falta de Inspecci√≥n")
  // ESTO ES LO QUE FALTABA PARA EL NOMBRE DEL √ÅREA
  const getNombreArea = (idEstado) => {
      const col = STATUS_COLUMNS.find(c => c.id === idEstado);
      return col ? col.label : idEstado;
  };

  // ==========================
  // MODO EDICI√ìN
  // ==========================
  if (editingVehicleId) {
    const idx = vehicles.findIndex(v => v.id === editingVehicleId);
    if (idx === -1) return;

    const original = vehicles[idx];

    // üîî NOTIFICACI√ìN AL T√âCNICO (Con √Årea)
    if (tecnico && original.tecnico !== tecnico) {
        const nombreArea = getNombreArea(original.estado);
        crearNotificacion(
            "tecnico", 
            tecnico, 
            `üõ†Ô∏è Trabajo asignado: ${placa} (${modelo}) en el √°rea de ${nombreArea.toUpperCase()}`
        );
    }

    vehicles[idx] = {
      ...original,
      vin, placa, modelo, propietario, cedula,
      aseguradora, asesor, tecnico,
      fecha_ingreso, fecha_salida, hora_salida,
      danos, equipamiento,
      archivoOrden: archivoOrden || original.archivoOrden,
      archivosCliente: archivosCliente.length ? archivosCliente : (original.archivosCliente || []),
      archivosAutorizaciones: archivosAutorizaciones.length ? archivosAutorizaciones : (original.archivosAutorizaciones || []),
      archivosProformas: archivosProformas.length ? archivosProformas : (original.archivosProformas || [])
    };

    editingVehicleId = null;

  // ==========================
  // MODO NUEVO
  // ==========================
  } else {
    const estadoInicial = "falta_inspeccion";
    
    const newVehicle = {
      id: Date.now(),
      vin, placa, modelo, propietario, cedula,
      aseguradora, asesor, tecnico,
      fecha_ingreso, fecha_salida, hora_salida,
      estado: estadoInicial, 
      danos, equipamiento,
      archivoOrden,
      archivosCliente, archivosAutorizaciones, archivosProformas,
      presupuesto: [], 
      ordenes: []
    };

    vehicles.push(newVehicle);

    // üîî NOTIFICACI√ìN AL T√âCNICO (Nuevo con √Årea)
    if (tecnico) {
        const nombreArea = getNombreArea(estadoInicial);
        crearNotificacion(
            "tecnico", 
            tecnico, 
            `üõ†Ô∏è Nuevo trabajo: ${placa} (${modelo}) ingres√≥ a ${nombreArea.toUpperCase()}`
        );
    }
  }
  // Al final, antes de renderBoard():
    guardarCambios(); // <--- IMPORTANTE
    renderBoard();
    form.reset();
  renderBoard();
  form.reset();
  resetFormSelectionGroups();
  showView("tablero");
});

// Editar Vehiculo
document.getElementById("btnEditarVehiculo").addEventListener("click", () => {
    const v = vehicles.find(v => v.id === window.currentVehicleId);
    if (!v) return;
    editingVehicleId = v.id;
    form.reset(); resetFormSelectionGroups();
    document.getElementById("vin").value = v.vin || "";
    document.getElementById("placa").value = v.placa || "";
    document.getElementById("modelo").value = v.modelo || "";
    document.getElementById("propietario").value = v.propietario || "";
    document.getElementById("cedula").value = v.cedula || "";
    document.getElementById("aseguradora").value = v.aseguradora || "";
    document.getElementById("asesor").value = v.asesor || "";
    document.getElementById("tecnico").value = v.tecnico || "";
    document.getElementById("fecha_ingreso").value = v.fecha_ingreso || "";
    document.getElementById("fecha_salida").value = v.fecha_salida || "";
    document.getElementById("hora_salida").value = v.hora_salida || "";
    if (v.danos) document.querySelectorAll('input[name="danos"]').forEach(chk => chk.checked = v.danos.includes(chk.value));
    if (v.equipamiento) document.querySelectorAll('input[name="equipamiento"]').forEach(chk => chk.checked = v.equipamiento.includes(chk.value));
    showView("form");
});
document.getElementById("btnEliminarVehiculo").addEventListener("click", () => {
    if(confirm("¬øEliminar veh√≠culo?")) {
        vehicles = vehicles.filter(v => v.id !== window.currentVehicleId);
        renderBoard(); showView("tablero");
    }
});

// ===============================================
// üíé NUEVA VISTA DE DETALLE (SEPARADA: FOTOS VS DOCS)
// ===============================================
// ===============================================
// üíé VISTA DETALLE PROTEGIDA (Oculta dinero a t√©cnicos)
// ===============================================
function openVehicleDetail(vehicleId) {
    const v = vehicles.find(x => x.id == vehicleId);
    if (!v) return;
    window.currentVehicleId = vehicleId;

    // 1. Preparar datos financieros (Calculamos igual, pero decidimos si mostrar luego)
    const p = v.presupuestoDesglose || {};
    const sectores = [
        { id: 'repuestos', label: 'Repuestos' },
        { id: 'enderezado', label: 'Enderezado' },
        { id: 'pintura', label: 'Pintura' },
        { id: 'otros', label: 'Otros' }
    ];
    
    let htmlTablaFinanciera = "";
    let tSeg = 0, tPriv = 0;

    sectores.forEach(sec => {
        const valSeg = Number(p[`seg_${sec.id}_v`]) || 0;
        const valPriv = Number(p[`priv_${sec.id}_v`]) || 0;
        tSeg += valSeg; tPriv += valPriv;

        if (valSeg > 0 || valPriv > 0) {
            htmlTablaFinanciera += `
                <tr>
                    <td>${sec.label}</td>
                    <td>$ ${valSeg.toFixed(2)}</td>
                    <td>$ ${valPriv.toFixed(2)}</td>
                    <td style="font-weight:bold;">$ ${(valSeg + valPriv).toFixed(2)}</td>
                </tr>
            `;
        }
    });

    const granTotal = tSeg + tPriv;
    htmlTablaFinanciera += `
        <tr class="fin-total-row">
            <td>TOTALES</td>
            <td>$ ${tSeg.toFixed(2)}</td>
            <td>$ ${tPriv.toFixed(2)}</td>
            <td>$ ${granTotal.toFixed(2)}</td>
        </tr>
    `;

    // üîí CANDADO DE SEGURIDAD PARA DETALLE
    // Definimos qu√© se muestra en la tarjeta financiera
    let bloqueFinanciero = "";
    
    // Si NO es t√©cnico, mostramos la tabla. Si ES t√©cnico, se queda vac√≠o.
    if (currentUser && currentUser.rol !== "tecnico") {
        bloqueFinanciero = `
            <div class="detail-card">
                <h3><i class="fa-solid fa-file-invoice-dollar"></i> Valores Autorizados</h3>
                <table class="fin-table">
                    <thead><tr><th>Rubro</th><th>Seguro</th><th>Cliente</th><th>Total</th></tr></thead>
                    <tbody>${htmlTablaFinanciera || '<tr><td colspan="4" style="text-align:center; padding:20px; color:#999;">Sin valores registrados</td></tr>'}</tbody>
                </table>
            </div>
        `;
    }

    // 2. CLASIFICACI√ìN DE ARCHIVOS
    let htmlGaleria = "";
    let htmlDocumentos = "";
    
    const todosLosArchivos = [
        ...(v.archivoOrden ? [v.archivoOrden] : []), 
        ...(v.archivosCliente || []),
        ...(v.archivosAutorizaciones || []),
        ...(v.archivosProformas || [])
    ];

    if (todosLosArchivos.length === 0) {
        htmlGaleria = `<div style="padding:20px; text-align:center; color:#999; border:2px dashed #eee; border-radius:8px; font-size:12px;">Sin im√°genes</div>`;
        htmlDocumentos = `<div style="padding:15px; text-align:center; color:#999; font-size:12px;">Sin documentos adjuntos</div>`;
    } else {
        let hayFotos = false;
        let hayDocs = false;

        todosLosArchivos.forEach(f => {
            if (f.tipo.includes("image")) {
                hayFotos = true;
                htmlGaleria += `
                    <div class="gallery-item" onclick="abrirFotoGrande('${f.base64}')" title="${f.nombre}">
                        <img src="${f.base64}" class="gallery-img">
                        <div class="gallery-overlay">${f.nombre}</div>
                    </div>
                `;
            } else {
                hayDocs = true;
                let icono = "fa-file-lines";
                if(f.tipo.includes("pdf")) icono = "fa-file-pdf";
                
                htmlDocumentos += `
                    <div class="doc-item">
                        <i class="fa-solid ${icono} doc-icon"></i>
                        <a href="${f.base64}" download="${f.nombre}" class="doc-link">${f.nombre}</a>
                        <a href="${f.base64}" download="${f.nombre}" class="doc-download" title="Descargar"><i class="fa-solid fa-download"></i></a>
                    </div>
                `;
            }
        });

        if(!hayFotos) htmlGaleria = `<div style="padding:20px; text-align:center; color:#999; border:2px dashed #eee; border-radius:8px; font-size:12px;">Sin im√°genes</div>`;
        if(!hayDocs) htmlDocumentos = `<div style="padding:15px; text-align:center; color:#999; font-size:12px;">Sin documentos adjuntos</div>`;
    }

    // 3. CONSTRUIR EL HTML
    const panel = document.querySelector("#view-detalle .panel-detalle");
    
    panel.innerHTML = `
        <div class="detail-header-card">
            <div>
                <h1 style="margin:0; font-size:24px;">${v.placa}</h1>
                <div style="opacity:0.9; font-size:14px;">${v.modelo}</div>
            </div>
            <div style="text-align:right;">
                <div style="background:rgba(255,255,255,0.2); padding:5px 12px; border-radius:20px; font-size:12px; display:inline-block;">
                    ${v.estado.toUpperCase().replace("_", " ")}
                </div>
                <div style="margin-top:5px; font-size:12px;">VIN: ${v.vin || "N/A"}</div>
            </div>
        </div>

        <div style="margin-bottom:20px; display:flex; justify-content:space-between;">
            <button id="btnVolverDetalleCustom" class="btn btn-link">&larr; Volver al tablero</button>
            <div style="display:flex; gap:10px;">
                <button onclick="editarVehiculoDesdeDetalle(${v.id})" class="btn btn-secondary"><i class="fa-solid fa-pen"></i> Editar Datos</button>
                <button onclick="eliminarVehiculoDesdeDetalle(${v.id})" class="btn btn-danger"><i class="fa-solid fa-trash"></i> Eliminar</button>
            </div>
        </div>

        <div class="detail-main-grid">
            <div>
                <div class="detail-card">
                    <h3><i class="fa-solid fa-circle-info"></i> Informaci√≥n General</h3>
                    <div class="info-row"><span class="info-label">Propietario</span> <span class="info-val">${v.propietario}</span></div>
                    <div class="info-row"><span class="info-label">C√©dula / RUC</span> <span class="info-val">${v.cedula || "-"}</span></div>
                    <div class="info-row"><span class="info-label">Aseguradora</span> <span class="info-val">${v.aseguradora || "-"}</span></div>
                    <div class="info-row"><span class="info-label">Asesor</span> <span class="info-val">${v.asesor || "-"}</span></div>
                    <div class="info-row"><span class="info-label">T√©cnico</span> <span class="info-val">${v.tecnico || "Sin asignar"}</span></div>
                </div>

                ${bloqueFinanciero}
                
                <div class="detail-card">
                     <h3><i class="fa-solid fa-list-check"></i> Historial de √ìrdenes</h3>
                     <div id="listaOrdenesCustom" style="max-height:150px; overflow-y:auto; margin-bottom:10px;"></div>
                     <form id="formOrdenCustom" style="display:flex; gap:5px;">
                        <input type="text" id="inputOrdenCustom" placeholder="Nueva orden / comentario..." style="flex:1; padding:6px; border:1px solid #ddd; border-radius:6px;">
                        <button type="submit" class="btn btn-primary" style="padding:6px 12px;">Agregar</button>
                     </form>
                </div>
            </div>

            <div>
                <div class="detail-card">
                    <h3><i class="fa-solid fa-calendar"></i> Fechas</h3>
                    <div class="info-row"><span class="info-label">Ingreso</span> <span class="info-val">${v.fecha_ingreso || "-"}</span></div>
                    <div class="info-row"><span class="info-label">Salida Est.</span> <span class="info-val">${v.fecha_salida || "-"}</span></div>
                    <div class="info-row"><span class="info-label">Hora Entrega</span> <span class="info-val">${v.hora_salida || "-"}</span></div>
                </div>

                <div class="detail-card">
                    <h3><i class="fa-solid fa-images"></i> Galer√≠a de Fotos</h3>
                    <div class="gallery-grid">
                        ${htmlGaleria}
                    </div>
                </div>

                <div class="detail-card">
                    <h3><i class="fa-solid fa-folder-open"></i> Documentos y √ìrdenes</h3>
                    <div class="doc-list">
                        ${htmlDocumentos}
                    </div>
                </div>
                
                <div class="detail-card">
                    <h3><i class="fa-solid fa-car-crash"></i> Estado Inicial</h3>
                    <div style="font-size:12px; color:#555; margin-bottom:5px;"><strong>Da√±os:</strong> ${v.danos ? v.danos.join(", ") : "Ninguno"}</div>
                    <div style="font-size:12px; color:#555;"><strong>Equipamiento:</strong> ${v.equipamiento ? v.equipamiento.join(", ") : "Ninguno"}</div>
                </div>
            </div>
        </div>
    `;
    
    // --- L√ìGICA DE BOTONES INTERNOS ---
    document.getElementById("btnVolverDetalleCustom").onclick = () => showView("tablero");

    const renderOrdenesCustom = () => {
        const div = document.getElementById("listaOrdenesCustom");
        div.innerHTML = "";
        (v.ordenes || []).forEach(o => {
            div.innerHTML += `<div style="background:#f8fafc; padding:8px; border-radius:6px; margin-bottom:5px; font-size:12px; border-left:3px solid #007dc5;">
                <div style="font-weight:bold; font-size:10px; color:#999;">${o.fecha}</div>
                <div>${o.descripcion}</div>
            </div>`;
        });
    };
    renderOrdenesCustom();

    document.getElementById("formOrdenCustom").onsubmit = (e) => {
        e.preventDefault();
        const txt = document.getElementById("inputOrdenCustom").value;
        if(!txt) return;
        v.ordenes.push({ fecha: new Date().toLocaleString(), descripcion: txt });
        renderOrdenesCustom();
        document.getElementById("inputOrdenCustom").value = "";
        if(typeof guardarCambios === "function") guardarCambios();
    };

    showView("detalle");
}

// --- FUNCIONES AUXILIARES NUEVAS ---
function abrirFotoGrande(base64) {
    const w = window.open("");
    w.document.write(`<img src="${base64}" style="width:100%; height:auto;">`);
}

function editarVehiculoDesdeDetalle(id) {
    const v = vehicles.find(x => x.id == id);
    if (!v) return;
    editingVehicleId = v.id;
    // Llenar formulario con l√≥gica existente
    form.reset(); resetFormSelectionGroups();
    document.getElementById("vin").value = v.vin || "";
    document.getElementById("placa").value = v.placa || "";
    document.getElementById("modelo").value = v.modelo || "";
    document.getElementById("propietario").value = v.propietario || "";
    document.getElementById("cedula").value = v.cedula || "";
    document.getElementById("aseguradora").value = v.aseguradora || "";
    document.getElementById("asesor").value = v.asesor || "";
    document.getElementById("tecnico").value = v.tecnico || "";
    document.getElementById("fecha_ingreso").value = v.fecha_ingreso || "";
    document.getElementById("fecha_salida").value = v.fecha_salida || "";
    document.getElementById("hora_salida").value = v.hora_salida || "";
    if (v.danos) document.querySelectorAll('input[name="danos"]').forEach(chk => chk.checked = v.danos.includes(chk.value));
    if (v.equipamiento) document.querySelectorAll('input[name="equipamiento"]').forEach(chk => chk.checked = v.equipamiento.includes(chk.value));
    showView("form");
}

function eliminarVehiculoDesdeDetalle(id) {
    if(confirm("¬øEliminar este veh√≠culo permanentemente?")) {
        vehicles = vehicles.filter(x => x.id != id);
        if(typeof guardarCambios === "function")
        guardarCambios();
        renderBoard();
        showView("tablero");
    }
}

// ===============================================
// üîÑ FUNCIONES VITALES RESTAURADAS
// ===============================================

// 1. Resumen Flotante (Click simple en tarjeta)
function showVehicleSummary(v) {
    document.getElementById("vs-placa").textContent = v.placa;
    document.getElementById("vs-modelo").textContent = v.modelo;
    document.getElementById("vs-estado").textContent = v.estado;
    // Llenar resto de datos para el resumen flotante
    document.getElementById("vs-vin").textContent = v.vin || "-";
    document.getElementById("vs-propietario").textContent = v.propietario || "-";
    document.getElementById("vs-aseguradora").textContent = v.aseguradora || "-";
    document.getElementById("vs-asesor").textContent = v.asesor || "-";
    document.getElementById("vs-tecnico").textContent = v.tecnico || "-";
    document.getElementById("vs-fecha-ing").textContent = v.fecha_ingreso || "-";
    document.getElementById("vs-fecha-sal").textContent = v.fecha_salida || "-";
    
    // Ultima OT en resumen
    const ultOT = v.ordenes && v.ordenes.length > 0 ? v.ordenes[v.ordenes.length - 1].descripcion : "Ninguna";
    document.getElementById("vs-ot").textContent = ultOT;

    document.getElementById("vehicleSummary").classList.add("show");
}
document.getElementById("vs-close").addEventListener("click", () => document.getElementById("vehicleSummary").classList.remove("show"));

// 2. Auditor√≠a (MEJORADA CON BUSCADOR)
function renderizarAuditoria(filtro = "") {
    const body = document.getElementById("auditoriaBody"); 
    body.innerHTML = "";
    
    // Usamos una copia [...auditoria] para no desordenar la lista original
    // reverse() hace que salgan los movimientos m√°s nuevos primero
    const listaVisual = [...auditoria].reverse(); 
    
    // Aplicar filtro si existe
    const listaFiltrada = listaVisual.filter(a => {
        if (!filtro) return true;
        const texto = filtro.toLowerCase();
        // Busca por Placa O por Usuario
        return (a.placa && a.placa.toLowerCase().includes(texto)) || 
               (a.usuario && a.usuario.toLowerCase().includes(texto));
    });

    // Dibujar tabla
    listaFiltrada.forEach(a => { 
        body.innerHTML += `
        <tr>
            <td>${a.fecha}</td>
            <td>${a.hora}</td>
            <td>${a.usuario}</td>
            <td style="font-weight:bold;">${a.placa}</td>
            <td>${a.desde}</td>
            <td>${a.hacia}</td>
            <td>${a.accion}</td>
            <td style="font-size:11px; color:#555;">${a.descripcion}</td>
        </tr>`; 
    });
}

// Bot√≥n para abrir
document.getElementById("btnAuditoria").addEventListener("click", () => {
    // Limpiamos el buscador al abrir
    const input = document.getElementById("auditoriaSearch");
    if(input) input.value = "";
    
    renderizarAuditoria(); // Mostrar todo
    showView("auditoria");
});

// Evento para el Buscador (ESTO FALTABA)
document.getElementById("auditoriaSearch").addEventListener("input", (e) => {
    renderizarAuditoria(e.target.value);
});

document.getElementById("btnVolverDesdeAuditoria").addEventListener("click", () => showView("tablero"));

// 3. LocalStorage (Respaldos)
document.getElementById("btnGuardarLocal").addEventListener("click", () => {
    const blob = new Blob([JSON.stringify({ vehicles, auditoria })], { type: "application/json" });
    const a = document.createElement("a"); a.href = URL.createObjectURL(blob); a.download = "backup.json"; a.click();
});
document.getElementById("inputCargarLocalInput").addEventListener("change", (e) => {
    const r = new FileReader(); r.onload = () => { const d = JSON.parse(r.result); vehicles = d.vehicles; auditoria = d.auditoria; renderBoard(); };
    r.readAsText(e.target.files[0]);
});
document.getElementById("btnCargarLocal").addEventListener("click", () => document.getElementById("inputCargarLocalInput").click());

// 4. Buscador
document.getElementById("searchInput").addEventListener("input", renderBoard);

// 5. Bot√≥n Ver Tablero
document.getElementById("btnVerTablero").addEventListener("click", () => {
    const searchInput = document.getElementById("searchInput");
    if(searchInput) {
        searchInput.value = ""; 
        if(typeof searchQuery !== 'undefined') searchQuery = ""; 
    }
    showView("tablero");
    renderBoard();
});

// ===============================================
// üîß L√ìGICA UI NOTIFICACIONES (FINAL Y CORREGIDA)
// ===============================================
const btnCampanaEl = document.getElementById("btnNotificaciones");
const panelNotifEl = document.getElementById("notifPanel");
const btnMarkReadEl = document.getElementById("btnMarkRead");

if (btnCampanaEl && panelNotifEl) {
    // 1. Limpiar eventos previos (clonar nodo)
    const newBtn = btnCampanaEl.cloneNode(true);
    btnCampanaEl.parentNode.replaceChild(newBtn, btnCampanaEl);

    // 2. Al hacer click en la campana
    newBtn.addEventListener("click", (e) => {
        e.stopPropagation(); // Evita que el clic llegue al documento
        const isClosed = !panelNotifEl.classList.contains("show");
        
        // Cerrar cualquier otro men√∫ si hubiera
        document.querySelectorAll(".show").forEach(el => el.classList.remove("show"));
        
        if (isClosed) {
            panelNotifEl.classList.add("show");
            checkNotificaciones(); // Refrescar lista al abrir
        }
    });

    // 3. Al hacer click DENTRO del panel (no cerrar)
    panelNotifEl.addEventListener("click", (e) => {
        e.stopPropagation();
    });

    // 4. Al hacer click AFUERA (en cualquier parte de la pantalla)
    document.addEventListener("click", () => {
        panelNotifEl.classList.remove("show");
    });
}

// L√≥gica del bot√≥n "Marcar le√≠das" (CORREGIDO DEFINITIVO)
if (btnMarkReadEl) {
    // Limpiar eventos previos para evitar duplicados
    const newMark = btnMarkReadEl.cloneNode(true);
    btnMarkReadEl.parentNode.replaceChild(newMark, btnMarkReadEl);

    newMark.addEventListener("click", (e) => {
        e.stopPropagation(); // Evita que el panel se cierre al hacer clic
        if(!currentUser) return;
        
        let cambios = false;
        
        // Recorremos todas las notificaciones
        notificaciones.forEach(n => {
            // 1. Si soy Asesor O Admin -> Marco le√≠das las de asesores
            const esParaAsesor = (n.rolDestino === "asesor") && (currentUser.rol === "asesor" || currentUser.rol === "admin");
            
            // 2. Si soy T√©cnico -> Marco le√≠das las m√≠as (IGNORANDO MAY√öSCULAS)
            let esParaTecnico = false;
            if (currentUser.rol === "tecnico" && n.rolDestino === "tecnico") {
                const destino = (n.usuarioDestino || "").toUpperCase();
                const yo = (currentUser.nombre || "").toUpperCase();
                if (destino === yo) {
                    esParaTecnico = true;
                }
            }

            // Si es para m√≠ (Asesor o T√©cnico), la marco
            if (esParaAsesor || esParaTecnico) {
                if(!n.leida) {
                    n.leida = true;
                    cambios = true;
                }
            }
        });
        
        // Si hubo cambios, guardamos y actualizamos visualmente
        if(cambios) {
            localStorage.setItem("axtrom_notificaciones", JSON.stringify(notificaciones));
            checkNotificaciones();
            if(typeof guardarCambios === "function") guardarCambios(); // <--- AGREGAR ESTO
        }
    });
}

// ===============================================
// üí∞ L√ìGICA DE PRESUPUESTO INTERACTIVO (FINAL)
// ===============================================
let vehiculoEnEdicionPresupuesto = null;

function abrirModalPresupuesto(idVehiculo) {
    const v = vehicles.find(x => x.id === idVehiculo);
    if(!v) return;
    
    vehiculoEnEdicionPresupuesto = idVehiculo;
    document.getElementById("modalPlacaTitulo").textContent = v.placa;
    
    // Cargar datos
    const datos = v.presupuestoDesglose || {};
    
    // Lista de campos
    const camposSeg = ['seg_repuestos_v', 'seg_enderezado_v', 'seg_pintura_v', 'seg_otros_v'];
    const camposPriv = ['priv_repuestos_v', 'priv_enderezado_v', 'priv_pintura_v', 'priv_otros_v'];
    
    // Llenar inputs y verificar si hay datos para activar checks
    let haySeguro = false;
    let hayPrivado = false;

    [...camposSeg, ...camposPriv].forEach(id => {
        const val = datos[id] || "";
        document.getElementById(id).value = val;
        
        // Si hay un valor mayor a 0, marcamos que existe esa secci√≥n
        if(Number(val) > 0) {
            if(id.startsWith('seg')) haySeguro = true;
            if(id.startsWith('priv')) hayPrivado = true;
        }
    });

    // Configurar estado visual inicial (Checks y Despliegue)
    configurarSeccion('secSeguro', 'checkSeguro', haySeguro);
    configurarSeccion('secPrivado', 'checkPrivado', hayPrivado);

    calcularTotalesPresupuesto();
    document.getElementById("modalPresupuesto").style.display = "flex";
}

// Funci√≥n auxiliar para forzar estado visual
function configurarSeccion(idSeccion, idCheck, activo) {
    const div = document.getElementById(idSeccion);
    const chk = document.getElementById(idCheck);
    const header = div.previousElementSibling; // El encabezado gris

    chk.checked = activo;
    if (activo) {
        div.classList.add("show");
        header.classList.add("active");
    } else {
        div.classList.remove("show");
        header.classList.remove("active");
    }
}

// Funci√≥n disparada por el Click
function toggleSection(idSeccion, fromCheckbox = false) {
    const div = document.getElementById(idSeccion);
    const header = div.previousElementSibling;
    const chk = header.querySelector("input[type='checkbox']");

    // Si clicamos el header (gris), invertimos el check. 
    // Si clicamos directo el check, ya cambi√≥ su estado solo.
    if (!fromCheckbox) {
        chk.checked = !chk.checked;
    }

    // Mostrar u ocultar basado en el estado final del check
    if (chk.checked) {
        div.classList.add("show");
        header.classList.add("active");
    } else {
        div.classList.remove("show");
        header.classList.remove("active");
    }
}

function cerrarModalPresupuesto() {
    document.getElementById("modalPresupuesto").style.display = "none";
}

function guardarModalPresupuesto() {
    const idx = vehicles.findIndex(v => v.id === vehiculoEnEdicionPresupuesto);
    if(idx === -1) return;

    const inputs = document.querySelectorAll('.pres-input');
    const nuevosDatos = {};
    inputs.forEach(inp => nuevosDatos[inp.id] = inp.value);

    vehicles[idx].presupuestoDesglose = nuevosDatos;
    
    if(typeof guardarCambios === "function") guardarCambios();
    guardarCambios(); // <--- IMPORTANTE
    cerrarModalPresupuesto();
}

// Event Listeners para c√°lculo
setTimeout(() => {
    document.querySelectorAll('.pres-input').forEach(input => {
        input.addEventListener('input', calcularTotalesPresupuesto);
    });
}, 500);

function calcularTotalesPresupuesto() {
    let totalSeg = 0;
    let totalPriv = 0;

    document.querySelectorAll('.calc-seg').forEach(inp => totalSeg += Number(inp.value) || 0);
    document.querySelectorAll('.calc-priv').forEach(inp => totalPriv += Number(inp.value) || 0);

    const spanSeg = document.getElementById("totalSeguroDisplay");
    const spanPriv = document.getElementById("totalPrivadoDisplay");
    
    if(spanSeg) spanSeg.textContent = totalSeg > 0 ? "$ " + totalSeg.toFixed(2) : "0.00";
    if(spanPriv) spanPriv.textContent = totalPriv > 0 ? "$ " + totalPriv.toFixed(2) : "0.00";
}

// ===============================================
// üìä L√ìGICA DE REPORTE DE PRESUPUESTOS (FILTROS ELEGANTES)
// ===============================================

// 1. Configurar botones
const btnPresupuestoMain = document.getElementById("btnPresupuesto");
if (btnPresupuestoMain) {
    btnPresupuestoMain.addEventListener("click", () => {
        limpiarFiltrosPresupuesto();
        showView("presupuesto");
    });
}
document.getElementById("btnVolverDesdePresupuesto").addEventListener("click", () => showView("tablero"));

// 2. Listeners para los selects
const selectsFiltro = ["filtroAnio", "filtroMes", "filtroDia"];
selectsFiltro.forEach(id => {
    document.getElementById(id).addEventListener("change", renderPresupuestoGeneral);
    document.getElementById("filtroConSalida").addEventListener("change", renderPresupuestoGeneral);
});

function limpiarFiltrosPresupuesto() {
    document.getElementById("filtroAnio").value = "";
    document.getElementById("filtroMes").value = "";
    document.getElementById("filtroDia").value = "";
    renderPresupuestoGeneral();
}


function renderPresupuestoGeneral() {
    const sectores = [
        { id: "repuestos", label: "Repuestos" },
        { id: "enderezado", label: "Enderezado" },
        { id: "pintura", label: "Pintura" },
        { id: "otros", label: "Otros" }
    ];

    // Obtener valores de los filtros
    const fAnio = document.getElementById("filtroAnio").value;
    const fMes = document.getElementById("filtroMes").value;
    const fDia = document.getElementById("filtroDia").value;
    
    // Obtener estado del Checkbox (Proyecci√≥n)
    const soloConSalida = document.getElementById("filtroConSalida")?.checked;

    // üõ°Ô∏è CANDADO DE SEGURIDAD (Esto faltaba en tu c√≥digo)
    // Si NO hay ning√∫n filtro activo, mostramos todo en cero y salimos.
    if (!fAnio && !fMes && !fDia && !soloConSalida) {
        document.getElementById("bodyPresupuestoGeneral").innerHTML = 
            '<tr><td colspan="4" style="text-align:center; padding:30px; color:#999; font-style:italic;"><i class="fa-solid fa-filter"></i> Aplique un filtro (A√±o, Mes o Proyecci√≥n) para visualizar valores.</td></tr>';
        
        document.getElementById("footSeguro").textContent = "$ 0.00";
        document.getElementById("footPrivado").textContent = "$ 0.00";
        document.getElementById("footTotal").textContent = "$ 0.00";
        document.getElementById("granTotalDisplay").textContent = "$ 0.00";
        document.getElementById("granTotalIvaDisplay").textContent = "$ 0.00";
        return; 
    }

    // Acumuladores
    let totales = {
        seguro: { repuestos:0, enderezado:0, pintura:0, otros:0 },
        privado: { repuestos:0, enderezado:0, pintura:0, otros:0 }
    };

    vehicles.forEach(v => {
        // üß† CEREBRO DEL CAMBIO: SELECCI√ìN DE FECHA INTELIGENTE
        // (Esto es lo que corrige el error de febrero)
        let fechaParaFiltrar = "";
        
        if (soloConSalida) {
            // MODO PROYECCI√ìN: Usamos Fecha de SALIDA
            if (!v.fecha_salida) return; 
            fechaParaFiltrar = v.fecha_salida;
        } else {
            // MODO NORMAL: Usamos Fecha de INGRESO
            if (!v.fecha_ingreso) return; 
            fechaParaFiltrar = v.fecha_ingreso;
        }

        // APLICAMOS LOS FILTROS SOBRE LA FECHA ELEGIDA (NO SIEMPRE INGRESO)
        let coincide = true;

        if (fAnio && !fechaParaFiltrar.startsWith(fAnio)) {
            coincide = false;
        }

        if (fMes) {
            const partes = fechaParaFiltrar.split("-"); 
            if (partes[1] !== fMes) coincide = false;
        }

        if (fDia) {
            const partes = fechaParaFiltrar.split("-");
            if (partes[2] !== fDia) coincide = false;
        }
        
        if (!coincide) return;

        // Sumar valores
        const p = v.presupuestoDesglose || {};
        sectores.forEach(sec => {
            totales.seguro[sec.id] += Number(p[`seg_${sec.id}_v`]) || 0;
            totales.privado[sec.id] += Number(p[`priv_${sec.id}_v`]) || 0;
        });
    });

    // Renderizar Tabla
    const tbody = document.getElementById("bodyPresupuestoGeneral");
    tbody.innerHTML = "";

    let granTotalSeg = 0;
    let granTotalPriv = 0;

    sectores.forEach(sec => {
        const valSeg = totales.seguro[sec.id];
        const valPriv = totales.privado[sec.id];
        const subTotal = valSeg + valPriv;

        granTotalSeg += valSeg;
        granTotalPriv += valPriv;

        const row = document.createElement("tr");
        row.style.borderBottom = "1px solid #eee";
        row.innerHTML = `
            <td style="padding:12px;">${sec.label}</td>
            <td style="padding:12px; text-align:right;">$ ${valSeg.toFixed(2)}</td>
            <td style="padding:12px; text-align:right;">$ ${valPriv.toFixed(2)}</td>
            <td style="padding:12px; text-align:right; font-weight:bold; background:#f9f9f9;">$ ${subTotal.toFixed(2)}</td>
        `;
        tbody.appendChild(row);
    });

    // C√ÅLCULOS FINALES
    const granTotal = granTotalSeg + granTotalPriv;
    const IVA_PORCENTAJE = 0.15; 
    const granTotalConIva = granTotal * (1 + IVA_PORCENTAJE);
    
    document.getElementById("footSeguro").textContent = "$ " + granTotalSeg.toFixed(2);
    document.getElementById("footPrivado").textContent = "$ " + granTotalPriv.toFixed(2);
    document.getElementById("footTotal").textContent = "$ " + granTotal.toFixed(2);
    
    document.getElementById("granTotalDisplay").textContent = "$ " + granTotal.toFixed(2);
    document.getElementById("granTotalIvaDisplay").textContent = "$ " + granTotalConIva.toFixed(2);
}
// =========================================
// ‚òÅÔ∏è CONEXI√ìN CON GOOGLE DRIVE (SHEETS)
// =========================================
const API_URL = "https://script.google.com/macros/s/AKfycbwhx7b0lNnEeKBj3bjtGlIVvj911LF_-u6P-snKTfl34nutMr09-Z09dUtbw8dkwzBw/exec"; // <--- ¬°IMPORTANTE! PEGA TU URL AQU√ç

async function cargarDatosDeNube() {
    const btnRefresh = document.getElementById("btnVerTablero");
    if(btnRefresh) {
        const textoOriginal = btnRefresh.innerHTML;
        btnRefresh.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Cargando...';
    }

    try {
        const response = await fetch(API_URL);
        const data = await response.json();
        
        if (data.vehicles && Array.isArray(data.vehicles)) {
            vehicles = data.vehicles;
        }
        if (data.auditoria && Array.isArray(data.auditoria)) {
            auditoria = data.auditoria;
        }
        // üëá ESTO ES LO NUEVO: CARGAR NOTIFICACIONES üëá
        if (data.notificaciones && Array.isArray(data.notificaciones)) {
            notificaciones = data.notificaciones;
            checkNotificaciones(); // Actualizar la campanita al instante
        }
        
        localStorage.setItem("axtrom_vehicles", JSON.stringify(vehicles));
        localStorage.setItem("axtrom_notificaciones", JSON.stringify(notificaciones)); // Respaldo local
        renderBoard();
        
    } catch (error) {
        console.error("Error cargando de nube:", error);
    } finally {
        if(btnRefresh) btnRefresh.innerHTML = '<i class="fa-solid fa-table-columns"></i> Ver tablero';
    }
}
function guardarEnNube() {
    fetch(API_URL, {
        method: "POST",
        body: JSON.stringify({
            vehicles: vehicles,
            auditoria: auditoria,
            notificaciones: notificaciones // <--- AHORA ENVIAMOS ESTO TAMBI√âN
        })
    })
    .then(res => res.json())
    .then(d => console.log("Guardado en nube exitoso"))
    .catch(e => console.error("Error guardando en nube", e));
}

// =========================================
// üîÑ AUTO-SINCRONIZACI√ìN
// =========================================
// 1. Cargar datos al iniciar sesi√≥n (Modificar loginSistema)


// 2. Guardar datos cada vez que se hace un cambio importante
// Modificamos la funci√≥n de guardado local para que tambi√©n mande a la nube
function guardarCambios() {
    // Guardado Local (Respaldo inmediato)
    localStorage.setItem("axtrom_vehicles", JSON.stringify(vehicles));
    
    // Guardado Nube (Drive)
    guardarEnNube();
}
// ================================================================
// üöë PARCHE DE CORRECCI√ìN: SINCRONIZACI√ìN DE NOTIFICACIONES
// ================================================================

// 1. Sobrescribir funci√≥n para enviar tambi√©n notificaciones a la nube
guardarEnNube = function() {
    fetch(API_URL, {
        method: "POST",
        body: JSON.stringify({
            vehicles: vehicles,
            auditoria: auditoria,
            notificaciones: notificaciones // <--- ¬°ESTO ES LO NUEVO!
        })
    })
    .then(res => res.json())
    .then(d => console.log("Guardado en nube exitoso"))
    .catch(e => console.error("Error guardando en nube", e));
};

// 2. Sobrescribir funci√≥n para descargar notificaciones de la nube
cargarDatosDeNube = async function() {
    const btnRefresh = document.getElementById("btnVerTablero");
    if(btnRefresh) {
        const textoOriginal = btnRefresh.innerHTML;
        btnRefresh.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Cargando...';
    }

    try {
        const response = await fetch(API_URL);
        const data = await response.json();
        
        if (data.vehicles && Array.isArray(data.vehicles)) {
            vehicles = data.vehicles;
        }
        if (data.auditoria && Array.isArray(data.auditoria)) {
            auditoria = data.auditoria;
        }
        // üëá AHORA S√ç LEEMOS LAS NOTIFICACIONES
        if (data.notificaciones && Array.isArray(data.notificaciones)) {
            notificaciones = data.notificaciones;
            // Guardamos copia local por si acaso
            localStorage.setItem("axtrom_notificaciones", JSON.stringify(notificaciones));
            checkNotificaciones(); // Actualizar campanita
        }
        
        localStorage.setItem("axtrom_vehicles", JSON.stringify(vehicles));
        renderBoard();
        
    } catch (error) {
        console.error("Error cargando de nube:", error);
    } finally {
        if(btnRefresh) btnRefresh.innerHTML = '<i class="fa-solid fa-table-columns"></i> Ver tablero';
    }
};

// 3. Sobrescribir crearNotificacion para que guarde INMEDIATAMENTE
crearNotificacion = function(rolDestino, usuarioDestino, mensaje) {
    const nuevaNotif = {
        id: Date.now(),
        fecha: new Date().toLocaleString(),
        rolDestino: rolDestino,
        usuarioDestino: usuarioDestino,
        mensaje: mensaje,
        leida: false
    };
    notificaciones.push(nuevaNotif);
    
    // Guardar en nube al instante
    guardarEnNube(); 
    checkNotificaciones(); 
};

// 4. Actualizar bot√≥n de "Marcar le√≠das" para que guarde en nube
const btnMarkFix = document.getElementById("btnMarkRead");
if(btnMarkFix) {
    // Clonamos para limpiar eventos viejos
    const newBtn = btnMarkFix.cloneNode(true);
    btnMarkFix.parentNode.replaceChild(newBtn, btnMarkFix);
    
    newBtn.addEventListener("click", (e) => {
        e.stopPropagation();
        if(!currentUser) return;
        let cambios = false;
        notificaciones.forEach(n => {
            const esParaAsesor = (n.rolDestino === "asesor") && (currentUser.rol === "asesor" || currentUser.rol === "admin");
            let esParaTecnico = false;
            if (currentUser.rol === "tecnico" && n.rolDestino === "tecnico") {
                const destino = (n.usuarioDestino || "").toUpperCase();
                const yo = (currentUser.nombre || "").toUpperCase();
                if (destino === yo) esParaTecnico = true;
            }
            if ((esParaAsesor || esParaTecnico) && !n.leida) {
                n.leida = true;
                cambios = true;
            }
        });
        
        if(cambios) {
            guardarEnNube(); // <--- GUARDAR EN NUBE AL MARCAR LE√çDAS
            checkNotificaciones();
        }
    });
}
// =========================================
// üõí SISTEMA DE FACTURACI√ìN AUTOM√ÅTICA
// =========================================

// 1. Configurar el bot√≥n para ver la lista
document.getElementById("btnVerFacturados").addEventListener("click", () => {
    mostrarListaFacturados();
});

// 2. Funci√≥n para archivar autom√°ticamente (Regla de 10 minutos)
// 2. Funci√≥n para archivar autom√°ticamente (CORREGIDA PARA NO ATASCAR CARROS)
function revisarFacturadosAntiguos() {
    const TIEMPO_LIMITE = 10 * 60 * 1000; // 10 minutos
    const ahora = Date.now();
    let huboCambios = false;

    vehicles.forEach(v => {
        if (v.estado === "facturados") {
            // CORRECCI√ìN: Si no tiene fecha (se qued√≥ estancado), le ponemos una vieja
            // para que se archive en el siguiente ciclo.
            if (!v.fecha_facturado) {
                v.fecha_facturado = ahora - (TIEMPO_LIMITE + 1000); 
            }

            if (ahora - v.fecha_facturado > TIEMPO_LIMITE) {
                v.estado = "facturados_archivado"; 
                huboCambios = true;
                console.log(`Auto-archivando veh√≠culo ${v.placa}`);
            }
        }
    });

    if (huboCambios) {
        if(typeof guardarCambios === "function") guardarCambios();
        if(typeof renderBoard === "function") renderBoard();
    }
}


// 3. Activar el reloj de revisi√≥n (Cada 1 minuto revisa)
setInterval(revisarFacturadosAntiguos, 60000);

// 4. Modificar handleDrop para marcar la hora de llegada
// (PEGA ESTE PEQUE√ëO BLOQUE DENTRO DE TU FUNCI√ìN handleDrop EXISTENTE)
/* Busca donde dice: vehicle.estado = newStatus;
   Y agrega esto justo debajo:
*/
/*
   if (newStatus === "facturados") {
       vehicle.fecha_facturado = Date.now(); // Guardamos la hora exacta
   }
*/

// 5. Vista de Lista de Facturados (CON FILTROS DE A√ëO Y MES)
function mostrarListaFacturados() {
    // Definir estructura HTML con los selectores de filtro
    const htmlEstructura = `
    <div style="padding:25px; background:white; border-radius:12px; margin:20px auto; max-width:950px; box-shadow:0 10px 40px rgba(0,0,0,0.3); font-family:system-ui; display:flex; flex-direction:column; max-height:90vh;">
        
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px; border-bottom:1px solid #eee; padding-bottom:15px;">
            <div>
                <h2 style="margin:0; color:#2e7d32; font-size:22px;"><i class="fa-solid fa-file-invoice-dollar"></i> Historial Facturados</h2>
                <span style="font-size:12px; color:#666;">Veh√≠culos procesados y archivados</span>
            </div>
            <button id="btnCloseFacturados" class="btn btn-secondary">Cerrar</button>
        </div>

        <div style="display:flex; gap:15px; background:#f8f9fa; padding:12px; border-radius:8px; margin-bottom:20px; align-items:center; border:1px solid #e9ecef;">
            <div style="font-size:12px; font-weight:bold; color:#555;"><i class="fa-solid fa-filter"></i> Filtrar por:</div>
            
            <select id="filtroFactAnio" style="padding:6px; border-radius:6px; border:1px solid #ccc; font-size:12px; cursor:pointer;">
                <option value="">Todos los A√±os</option>
                <option value="2024">2024</option>
                <option value="2025">2025</option>
                <option value="2026">2026</option>
                <option value="2027">2027</option>
                <option value="2028">2028</option>
            </select>

            <select id="filtroFactMes" style="padding:6px; border-radius:6px; border:1px solid #ccc; font-size:12px; cursor:pointer;">
                <option value="">Todos los Meses</option>
                <option value="01">Enero</option>
                <option value="02">Febrero</option>
                <option value="03">Marzo</option>
                <option value="04">Abril</option>
                <option value="05">Mayo</option>
                <option value="06">Junio</option>
                <option value="07">Julio</option>
                <option value="08">Agosto</option>
                <option value="09">Septiembre</option>
                <option value="10">Octubre</option>
                <option value="11">Noviembre</option>
                <option value="12">Diciembre</option>
            </select>
        </div>

        <div style="display:flex; gap:15px; margin-bottom:20px; justify-content:flex-end;">
            <div style="background:#f1f8e9; padding:10px 20px; border-radius:8px; text-align:right; border:1px solid #c5e1a5;">
                <div style="font-size:11px; color:#558b2f; font-weight:bold;">SUBTOTAL</div>
                <div id="factSubtotal" style="font-size:18px; font-weight:800; color:#33691e;">$ 0.00</div>
            </div>
            <div style="background:#fff3e0; padding:10px 20px; border-radius:8px; text-align:right; border:1px solid #ffe0b2;">
                <div style="font-size:11px; color:#ef6c00; font-weight:bold;">IVA (15%)</div>
                <div id="factIVA" style="font-size:18px; font-weight:800; color:#e65100;">$ 0.00</div>
            </div>
            <div style="background:#e3f2fd; padding:10px 20px; border-radius:8px; text-align:right; border:1px solid #bbdefb;">
                <div style="font-size:11px; color:#1565c0; font-weight:bold;">TOTAL NETO</div>
                <div id="factTotal" style="font-size:20px; font-weight:800; color:#0d47a1;">$ 0.00</div>
            </div>
        </div>

        <div style="overflow-y:auto; border:1px solid #eee; border-radius:8px; flex:1;">
            <table style="width:100%; border-collapse:collapse; font-size:12px;">
                <thead style="background:#f8fafc; position:sticky; top:0;">
                    <tr>
                        <th style="padding:12px; text-align:left; color:#64748b;">Placa / Modelo</th>
                        <th style="padding:12px; text-align:left; color:#64748b;">Cliente</th>
                        <th style="padding:12px; text-align:right; color:#64748b;">Fecha Archivo</th>
                        <th style="padding:12px; text-align:right; color:#64748b;">Monto ($)</th>
                        <th style="padding:12px; text-align:center; color:#64748b;">Acciones</th>
                    </tr>
                </thead>
                <tbody id="bodyFacturados">
                    </tbody>
            </table>
        </div>
    </div>
    `;

    // 1. Crear e inyectar el Overlay
    const overlay = document.createElement("div");
    overlay.id = "overlayFacturados";
    overlay.style = "position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); z-index:10000; display:flex; justify-content:center; align-items:center; padding:20px;";
    overlay.innerHTML = htmlEstructura;
    document.body.appendChild(overlay);

    // 2. Funci√≥n interna para renderizar la tabla seg√∫n los filtros
    const renderTablaFacturados = () => {
        const fAnio = document.getElementById("filtroFactAnio").value;
        const fMes = document.getElementById("filtroFactMes").value;
        
        // FILTRADO
        const listaFiltrada = vehicles.filter(v => {
            // Solo los archivados
            if (v.estado !== "facturados_archivado") return false;
            
            // Si por error no tiene fecha, lo mostramos si no hay filtros, o lo ocultamos si hay.
            if (!v.fecha_facturado) return fAnio === "" && fMes === ""; 

            const fechaObj = new Date(v.fecha_facturado);
            const vAnio = fechaObj.getFullYear().toString();
            // getMonth() da 0 para Enero, as√≠ que sumamos 1 y aseguramos 2 d√≠gitos ("01", "02")
            const vMes = (fechaObj.getMonth() + 1).toString().padStart(2, '0');

            if (fAnio && vAnio !== fAnio) return false;
            if (fMes && vMes !== fMes) return false;
            
            return true;
        });

        // ORDENAR: M√°s recientes primero
        listaFiltrada.sort((a, b) => b.fecha_facturado - a.fecha_facturado);

        // C√ÅLCULO DE TOTALES
        let sumaSubtotal = 0;
        listaFiltrada.forEach(v => {
            const p = v.presupuestoDesglose || {};
            const campos = ['seg_repuestos_v','seg_enderezado_v','seg_pintura_v','seg_otros_v','priv_repuestos_v','priv_enderezado_v','priv_pintura_v','priv_otros_v'];
            campos.forEach(k => sumaSubtotal += Number(p[k]||0));
        });

        const totalIVA = sumaSubtotal * 0.15;
        const granTotal = sumaSubtotal + totalIVA;

        // Actualizar tarjetas de dinero
        document.getElementById("factSubtotal").textContent = "$ " + sumaSubtotal.toLocaleString('en-US', {minimumFractionDigits: 2});
        document.getElementById("factIVA").textContent = "$ " + totalIVA.toLocaleString('en-US', {minimumFractionDigits: 2});
        document.getElementById("factTotal").textContent = "$ " + granTotal.toLocaleString('en-US', {minimumFractionDigits: 2});

        // Actualizar Tabla
        const tbody = document.getElementById("bodyFacturados");
        tbody.innerHTML = "";

        if(listaFiltrada.length === 0) {
            tbody.innerHTML = `<tr><td colspan="5" style="padding:40px; text-align:center; color:#999; font-style:italic;">No se encontraron veh√≠culos facturados con estos filtros.</td></tr>`;
        } else {
            listaFiltrada.forEach(v => {
                const fecha = new Date(v.fecha_facturado).toLocaleString();
                
                let totalRow = 0;
                const p = v.presupuestoDesglose || {};
                ['seg_repuestos_v','seg_enderezado_v','seg_pintura_v','seg_otros_v','priv_repuestos_v','priv_enderezado_v','priv_pintura_v','priv_otros_v'].forEach(k => totalRow += Number(p[k]||0));

                const tr = document.createElement("tr");
                tr.style.borderBottom = "1px solid #f1f5f9";
                tr.style.background = "white";
                tr.innerHTML = `
                    <td style="padding:10px;">
                        <div style="font-weight:bold; color:#333;">${v.placa}</div>
                        <div style="font-size:11px; color:#666;">${v.modelo}</div>
                    </td>
                    <td style="padding:10px;">${v.propietario}</td>
                    <td style="padding:10px; text-align:right;">${fecha}</td>
                    <td style="padding:10px; text-align:right; font-weight:bold; color:#0d47a1;">$ ${totalRow.toFixed(2)}</td>
                    <td style="padding:10px; text-align:center;">
                        <button class="btn-edit-fact" style="background:#e3f2fd; color:#0277bd; border:none; padding:4px 8px; border-radius:4px; cursor:pointer;" title="Editar"><i class="fa-solid fa-pen"></i></button>
                        <button class="btn-del-fact" style="background:#ffebee; color:#c62828; border:none; padding:4px 8px; border-radius:4px; cursor:pointer; margin-left:5px;" title="Eliminar"><i class="fa-solid fa-xmark"></i></button>
                    </td>
                `;
                
                // Asignar eventos a los botones
                tr.querySelector(".btn-edit-fact").onclick = () => editarDesdeFacturados(v.id);
                tr.querySelector(".btn-del-fact").onclick = () => eliminarDefinitivo(v.id);

                tbody.appendChild(tr);
            });
        }
    };

    // 3. Activar Listeners (Eventos)
    document.getElementById("filtroFactAnio").addEventListener("change", renderTablaFacturados);
    document.getElementById("filtroFactMes").addEventListener("change", renderTablaFacturados);

    // 4. Cerrar Modal
    const cerrarModal = () => { if(document.body.contains(overlay)) document.body.removeChild(overlay); };
    
    document.getElementById("btnCloseFacturados").onclick = cerrarModal;
    overlay.addEventListener("click", (e) => { if(e.target === overlay) cerrarModal(); });

    // 5. Carga inicial (sin filtros o con todo)
    renderTablaFacturados();
}
// --- FUNCIONES EXTRA PARA LOS BOTONES DE LA TABLA ---

// 1. Eliminar (X peque√±a)
function eliminarDefinitivo(id) {
    if(confirm("¬øEst√°s seguro de eliminar este registro hist√≥rico permanentemente?")) {
        vehicles = vehicles.filter(v => v.id !== id);
        guardarCambios();
        // Recargar la lista visualmente cerrando y abriendo (o actualizando el DOM, truco r√°pido: cerrar)
        const ov = document.getElementById("overlayFacturados");
        if(ov) document.body.removeChild(ov);
        mostrarListaFacturados(); 
    }
}

// 2. Editar (L√°piz)
function editarDesdeFacturados(id) {
    // Cerramos el modal de facturados
    const ov = document.getElementById("overlayFacturados");
    if(ov) document.body.removeChild(ov);
    
    // Usamos la funci√≥n de editar que ya tienes, que lleva al formulario
    editarVehiculoDesdeDetalle(id); 
}
</script>
<div id="modalPresupuesto" class="modal-overlay">
  <div class="modal-content">
    <div style="padding:15px; border-bottom:1px solid #eee;">
      <h3 style="margin:0; font-size:16px;">Detalle de Valores - <span id="modalPlacaTitulo"></span></h3>
      <p style="margin:0; font-size:11px; color:#666;">Seleccione el tipo de cobro e ingrese los valores.</p>
    </div>

    <div style="padding: 15px; max-height: 60vh; overflow-y: auto;">
      
      <div class="pres-section-container">
          <div class="pres-toggle-header" onclick="toggleSection('secSeguro')">
              <input type="checkbox" id="checkSeguro" class="big-check" onclick="event.stopPropagation(); toggleSection('secSeguro', true)">
              <div style="flex:1;">Valores por <strong>SEGURO</strong></div>
              <span id="totalSeguroDisplay" style="font-weight:bold; color:#007dc5;">0.00</span>
          </div>
          
          <div id="secSeguro" class="pres-content-body">
              <table class="pres-table">
                <thead>
                    <tr><th style="width:60%">Sectores</th><th style="text-align: right;">Venta ($)</th></tr>
                </thead>
                <tbody>
                  <tr><td class="pres-row-bg">Repuestos</td><td><input type="number" id="seg_repuestos_v" class="pres-input calc-seg" placeholder="0.00"></td></tr>
                  <tr><td class="pres-row-bg">Enderezado</td><td><input type="number" id="seg_enderezado_v" class="pres-input calc-seg" placeholder="0.00"></td></tr>
                  <tr><td class="pres-row-bg">Pintura</td><td><input type="number" id="seg_pintura_v" class="pres-input calc-seg" placeholder="0.00"></td></tr>
                  <tr><td class="pres-row-bg">Otros</td><td><input type="number" id="seg_otros_v" class="pres-input calc-seg" placeholder="0.00"></td></tr>
                </tbody>
              </table>
          </div>
      </div>

      <div class="pres-section-container">
          <div class="pres-toggle-header" onclick="toggleSection('secPrivado')">
              <input type="checkbox" id="checkPrivado" class="big-check" onclick="event.stopPropagation(); toggleSection('secPrivado', true)">
              <div style="flex:1;">Valores <strong>PRIVADOS</strong> (Cliente)</div>
              <span id="totalPrivadoDisplay" style="font-weight:bold; color:#007dc5;">0.00</span>
          </div>
          
          <div id="secPrivado" class="pres-content-body">
              <table class="pres-table">
                <thead>
                    <tr><th style="width:60%">Sectores</th><th style="text-align: right;">Venta ($)</th></tr>
                </thead>
                <tbody>
                  <tr><td class="pres-row-bg">Repuestos</td><td><input type="number" id="priv_repuestos_v" class="pres-input calc-priv" placeholder="0.00"></td></tr>
                  <tr><td class="pres-row-bg">Enderezado</td><td><input type="number" id="priv_enderezado_v" class="pres-input calc-priv" placeholder="0.00"></td></tr>
                  <tr><td class="pres-row-bg">Pintura</td><td><input type="number" id="priv_pintura_v" class="pres-input calc-priv" placeholder="0.00"></td></tr>
                  <tr><td class="pres-row-bg">Otros</td><td><input type="number" id="priv_otros_v" class="pres-input calc-priv" placeholder="0.00"></td></tr>
                </tbody>
              </table>
          </div>
      </div>

    </div>

    <div class="pres-footer">
      <button onclick="cerrarModalPresupuesto()" class="btn btn-secondary">Cancelar</button>
      <button onclick="guardarModalPresupuesto()" class="btn btn-primary">Guardar Valores</button>
    </div>
  </div>
</div>

</body>
</html>

